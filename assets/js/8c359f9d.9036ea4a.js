"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[9238],{4734(e,r,s){s.r(r),s.d(r,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>n,toc:()=>c});const n=JSON.parse('{"id":"app/scheduler/tasks/TASK_OPIK_EVALUATE","title":"Task: Opik Evaluate","description":"Scheduled task that processes recent Opik spans and runs evaluation experiments.","source":"@site/docs/app/scheduler/tasks/TASK_OPIK_EVALUATE.md","sourceDirName":"app/scheduler/tasks","slug":"/app/scheduler/tasks/TASK_OPIK_EVALUATE","permalink":"/docs/app/scheduler/tasks/TASK_OPIK_EVALUATE","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/app/scheduler/tasks/TASK_OPIK_EVALUATE.md","tags":[],"version":"current","frontMatter":{}}');var i=s(4848),t=s(8453);const l={},d="Task: Opik Evaluate",a={},c=[{value:"Overview",id:"overview",level:2},{value:"Schedule",id:"schedule",level:2},{value:"Parameters",id:"parameters",level:2},{value:"Workflow",id:"workflow",level:2},{value:"Usage",id:"usage",level:2},{value:"Via Admin Dashboard",id:"via-admin-dashboard",level:3},{value:"Via Scheduler",id:"via-scheduler",level:3},{value:"Programmatically",id:"programmatically",level:3},{value:"Result Structure",id:"result-structure",level:2},{value:"Metrics",id:"metrics",level:2},{value:"Default Metrics",id:"default-metrics",level:3},{value:"Available Metrics",id:"available-metrics",level:3},{value:"Error Cleanup",id:"error-cleanup",level:2},{value:"Error Patterns Detected",id:"error-patterns-detected",level:3},{value:"Disable Cleanup",id:"disable-cleanup",level:3},{value:"Redis Keys",id:"redis-keys",level:2},{value:"Files",id:"files",level:2},{value:"See Also",id:"see-also",level:2}];function o(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"task-opik-evaluate",children:"Task: Opik Evaluate"})}),"\n",(0,i.jsx)(r.p,{children:"Scheduled task that processes recent Opik spans and runs evaluation experiments."}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.code,{children:"task_opik_evaluate"})," handles the async nature of Opik span ingestion (spans take ~3 minutes to appear after creation) by running periodically to:"]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:"Clean up error traces (optional)"}),"\n",(0,i.jsx)(r.li,{children:"Search for recent spans not yet added to a dataset"}),"\n",(0,i.jsx)(r.li,{children:"Create a dataset from those spans"}),"\n",(0,i.jsx)(r.li,{children:"Run Opik evaluate() with configured metrics"}),"\n",(0,i.jsx)(r.li,{children:"Report results"}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"schedule",children:"Schedule"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'# Cron: Every 30 minutes, 7 AM - 10 PM\nOPIK_EVALUATE_CRON = "*/30 7-22 * * *"\n'})}),"\n",(0,i.jsx)(r.h2,{id:"parameters",children:"Parameters"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Parameter"}),(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"Default"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"date_string"})}),(0,i.jsx)(r.td,{children:"str"}),(0,i.jsx)(r.td,{children:"today"}),(0,i.jsx)(r.td,{children:"Date in YYYYMMDD format"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"experiment_type"})}),(0,i.jsx)(r.td,{children:"str"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:'"charter_optimization"'})}),(0,i.jsx)(r.td,{children:"Type from AGENT_FEATURE_REGISTRY"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"max_items"})}),(0,i.jsx)(r.td,{children:"int"}),(0,i.jsx)(r.td,{children:"50"}),(0,i.jsx)(r.td,{children:"Maximum spans to include"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"lookback_hours"})}),(0,i.jsx)(r.td,{children:"int"}),(0,i.jsx)(r.td,{children:"24"}),(0,i.jsx)(r.td,{children:"Hours to look back for spans"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"metrics"})}),(0,i.jsxs)(r.td,{children:["list",(0,i.jsx)(r.code,{children:"[str]"})]}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:'["hallucination", "output_format"]'})}),(0,i.jsx)(r.td,{children:"Opik metrics to use"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"task_provider"})}),(0,i.jsx)(r.td,{children:"str"}),(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:'"gemini"'})}),(0,i.jsx)(r.td,{children:"LLM provider for evaluation task"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"skip_if_empty"})}),(0,i.jsx)(r.td,{children:"bool"}),(0,i.jsx)(r.td,{children:"True"}),(0,i.jsx)(r.td,{children:"Skip without error if no new spans"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"cleanup_errors"})}),(0,i.jsx)(r.td,{children:"bool"}),(0,i.jsx)(r.td,{children:"True"}),(0,i.jsx)(r.td,{children:"Delete error traces before processing"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"workflow",children:"Workflow"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   task_opik_evaluate                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                             \u2502\n\u2502  Step 0: Cleanup Error Traces (if cleanup_errors=True)      \u2502\n\u2502          Delete traces with "error", "retries exhausted"    \u2502\n\u2502                         \u2193                                   \u2502\n\u2502  Step 1: Search Recent Spans                                \u2502\n\u2502          Filter: name = "{span_name}" AND type = "llm"      \u2502\n\u2502                         \u2193                                   \u2502\n\u2502  Step 2: Filter Already-Added                               \u2502\n\u2502          Exclude spans with added_to_dataset feedback       \u2502\n\u2502                         \u2193                                   \u2502\n\u2502  Step 3: Create Dataset                                     \u2502\n\u2502          dataset: {prefix}-{date}-{time}                    \u2502\n\u2502                         \u2193                                   \u2502\n\u2502  Step 4: Run Opik Evaluate                                  \u2502\n\u2502          experiment: {type}-eval-{date}-{time}              \u2502\n\u2502                                                             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,i.jsx)(r.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsx)(r.h3,{id:"via-admin-dashboard",children:"Via Admin Dashboard"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Navigate to ",(0,i.jsx)(r.strong,{children:"Admin"})," tab"]}),"\n",(0,i.jsxs)(r.li,{children:["Find ",(0,i.jsx)(r.strong,{children:"task_opik_evaluate"})," in Manual Triggers"]}),"\n",(0,i.jsxs)(r.li,{children:["Configure:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Experiment type"}),"\n",(0,i.jsx)(r.li,{children:"LLM provider"}),"\n",(0,i.jsx)(r.li,{children:"Max items"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["Click ",(0,i.jsx)(r.strong,{children:"Run Now"})]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"via-scheduler",children:"Via Scheduler"}),"\n",(0,i.jsx)(r.p,{children:"The task runs automatically every 30 minutes. To modify:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'# In app/services/scheduler/__init__.py\nOPIK_EVALUATE_CRON = "0 */2 * * *"  # Every 2 hours instead\n'})}),"\n",(0,i.jsx)(r.h3,{id:"programmatically",children:"Programmatically"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'from app.services.tasks.task_opik_evaluate import task_opik_evaluate\n\nresult = task_opik_evaluate(\n    experiment_type="charter_optimization",\n    max_items=100,\n    metrics=["hallucination", "moderation", "output_format"],\n    task_provider="ollama",\n    cleanup_errors=True,\n)\n'})}),"\n",(0,i.jsx)(r.h2,{id:"result-structure",children:"Result Structure"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:'{\n    "status": "success",  # or "skipped", "failed"\n    "task_id": "task_opik_evaluate",\n    "date_string": "20260204",\n    "experiment_type": "charter_optimization",\n    "max_items": 50,\n    "lookback_hours": 24,\n    "metrics": ["hallucination", "output_format"],\n    "task_provider": "gemini",\n    "cleanup_errors": True,\n    "cleanup_result": {\n        "project": "ocapistaine-test",\n        "total_traces": 408,\n        "error_traces": 5,\n        "deleted": 5,\n        "error_patterns": {"error": 3, "retries exhausted": 2}\n    },\n    "spans_found": 25,\n    "spans_new": 12,\n    "dataset_name": "charter-optimization-20260204-143052",\n    "experiment_result": {\n        "status": "success",\n        "experiment_name": "charter_optimization-eval-20260204-143052",\n        "eval_results": {...}\n    },\n    "errors": [],\n    "warnings": []\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"metrics",children:"Metrics"}),"\n",(0,i.jsx)(r.h3,{id:"default-metrics",children:"Default Metrics"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Metric"}),(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"hallucination"})}),(0,i.jsx)(r.td,{children:"builtin"}),(0,i.jsx)(r.td,{children:"Detects false information (LLM judge)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"output_format"})}),(0,i.jsx)(r.td,{children:"custom"}),(0,i.jsx)(r.td,{children:"Measures format compliance (0-1 scale)"})]})]})]}),"\n",(0,i.jsx)(r.h3,{id:"available-metrics",children:"Available Metrics"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"from app.processors.workflows.workflow_experiment import list_available_metrics\n\nfor m in list_available_metrics():\n    print(f\"{m['name']}: {m['description']} ({m['type']})\")\n"})}),"\n",(0,i.jsx)(r.h2,{id:"error-cleanup",children:"Error Cleanup"}),"\n",(0,i.jsx)(r.p,{children:"The task can automatically delete error traces before processing. This prevents:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Polluted optimization data"}),"\n",(0,i.jsx)(r.li,{children:"Divergent experiment results"}),"\n",(0,i.jsx)(r.li,{children:"Wasted compute on invalid traces"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"error-patterns-detected",children:"Error Patterns Detected"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"error"'})," - Generic errors"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"retries exhausted"'})," - API retry failures"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"rate limit"'})," - Rate limiting errors"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"validation error"'})," - LLM validation failures"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"timeout"'})," - Request timeouts"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:'"failed"'})," - Generic failures"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"disable-cleanup",children:"Disable Cleanup"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-python",children:"result = task_opik_evaluate(cleanup_errors=False)\n"})}),"\n",(0,i.jsx)(r.h2,{id:"redis-keys",children:"Redis Keys"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Key Pattern"}),(0,i.jsx)(r.th,{children:"TTL"}),(0,i.jsx)(r.th,{children:"Purpose"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"lock:task_opik_evaluate:{date}"})}),(0,i.jsx)(r.td,{children:"5 min"}),(0,i.jsx)(r.td,{children:"Prevent concurrent runs"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"success:task_opik_evaluate:{date}"})}),(0,i.jsx)(r.td,{children:"24h"}),(0,i.jsx)(r.td,{children:"Track completion"})]})]})]}),"\n",(0,i.jsxs)(r.p,{children:["Note: Task uses ",(0,i.jsx)(r.code,{children:"skip_success_check=True"})," so it can run multiple times per day."]}),"\n",(0,i.jsx)(r.h2,{id:"files",children:"Files"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"File"}),(0,i.jsx)(r.th,{children:"Purpose"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"app/services/tasks/task_opik_evaluate.py"})}),(0,i.jsx)(r.td,{children:"Task implementation"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"app/processors/workflows/workflow_experiment.py"})}),(0,i.jsx)(r.td,{children:"Experiment execution"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"app/services/scheduler/__init__.py"})}),(0,i.jsx)(r.td,{children:"Cron registration"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/docs/app/opik/EXPERIMENT_WORKFLOW",children:"Experiment Workflow"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/docs/app/scheduler/TASK_BOILERPLATE",children:"Task Boilerplate"})}),"\n",(0,i.jsx)(r.li,{children:(0,i.jsx)(r.a,{href:"/docs/app/scheduler/",children:"Scheduler README"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453(e,r,s){s.d(r,{R:()=>l,x:()=>d});var n=s(6540);const i={},t=n.createContext(i);function l(e){const r=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),n.createElement(t.Provider,{value:r},e.children)}}}]);