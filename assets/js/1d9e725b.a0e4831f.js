"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[3428],{6585(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"app/CORS_STRATEGY","title":"CORS Strategy for OCapistaine","description":"Overview","source":"@site/docs/app/CORS_STRATEGY.md","sourceDirName":"app","slug":"/app/CORS_STRATEGY","permalink":"/docs/app/CORS_STRATEGY","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/app/CORS_STRATEGY.md","tags":[],"version":"current","frontMatter":{},"sidebar":"appSidebar","previous":{"title":"Streamlit Quick Start - Fix 403 WebSocket Error","permalink":"/docs/app/STREAMLIT_QUICKSTART"},"next":{"title":"OCapistaine Scheduler Service","permalink":"/docs/app/scheduler/"}}');var s=i(4848),t=i(8453);const d={},l="CORS Strategy for OCapistaine",c={},o=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Production CORS",id:"production-cors",level:2},{value:"Development CORS",id:"development-cors",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Usage",id:"usage",level:3},{value:"Generated Origins",id:"generated-origins",level:3},{value:"Verification",id:"verification",level:3},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Streamlit CORS Variables",id:"streamlit-cors-variables",level:3},{value:"Input Variables",id:"input-variables",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"CORS Errors in Production",id:"cors-errors-in-production",level:3},{value:"CORS Errors in Development",id:"cors-errors-in-development",level:3},{value:"Origin Not in Allowed List",id:"origin-not-in-allowed-list",level:3},{value:"Related",id:"related",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"cors-strategy-for-ocapistaine",children:"CORS Strategy for OCapistaine"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"OCapistaine uses two CORS strategies depending on the environment:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Production (Render)"}),": Static allowed origins configured in ",(0,s.jsx)(n.code,{children:"render.yaml"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Development (ngrok)"}),": Dynamic origins generated by ",(0,s.jsx)(n.code,{children:"scripts/set_streamlit_env.py"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Production:\n  render.yaml \u2192 STREAMLIT_SERVER_ALLOWED_ORIGINS (static)\n  Vaettir Nginx \u2192 Render (ocapistaine.onrender.com)\n\nDevelopment:\n  .env \u2192 set_streamlit_env.py \u2192 STREAMLIT_SERVER_ALLOWED_ORIGINS (dynamic)\n  Vaettir Nginx \u2192 ngrok \u2192 localhost:8502\n"})}),"\n",(0,s.jsx)(n.h2,{id:"production-cors",children:"Production CORS"}),"\n",(0,s.jsxs)(n.p,{children:["On Render, origins are configured statically in ",(0,s.jsx)(n.code,{children:"render.yaml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'- key: STREAMLIT_SERVER_ALLOWED_ORIGINS\n  value: "https://ocapistaine.onrender.com,https://ocapistaine.vaettir.locki.io,https://vaettir.locki.io"\n'})}),"\n",(0,s.jsx)(n.p,{children:"No scripts or dynamic configuration needed. The Vaettir nginx proxy passes requests through with the correct headers, and Streamlit validates the origin against this list."}),"\n",(0,s.jsx)(n.h2,{id:"development-cors",children:"Development CORS"}),"\n",(0,s.jsxs)(n.p,{children:["For local development via ngrok, the ",(0,s.jsx)(n.code,{children:"set_streamlit_env.py"})," script auto-generates allowed origins."]}),"\n",(0,s.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Edit ",(0,s.jsx)(n.code,{children:".env"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"NGROK_DOMAIN=your-dev-tunnel.ngrok-free.app\nSTREAMLIT_PORT=8502\n\n# Optional: additional origins\n# STREAMLIT_CUSTOM_ORIGINS=https://custom.com\n"})}),"\n",(0,s.jsx)(n.h3,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Option A: Convenience script\n./scripts/run_streamlit.sh\n\n# Option B: Manual\neval $(python scripts/set_streamlit_env.py)\nstreamlit run app/front.py\n"})}),"\n",(0,s.jsx)(n.h3,{id:"generated-origins",children:"Generated Origins"}),"\n",(0,s.jsx)(n.p,{children:"The script builds the origin list from:"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Source"}),(0,s.jsx)(n.th,{children:"Origin"}),(0,s.jsx)(n.th,{children:"When"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Always"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"http://localhost:{STREAMLIT_PORT}"})}),(0,s.jsx)(n.td,{children:"Always"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Always"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"http://127.0.0.1:{STREAMLIT_PORT}"})}),(0,s.jsx)(n.td,{children:"Always"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:".env"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://{NGROK_DOMAIN}"})}),(0,s.jsxs)(n.td,{children:["If ",(0,s.jsx)(n.code,{children:"NGROK_DOMAIN"})," is set"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Hardcoded"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://ocapistaine-dev.vaettir.locki.io"})}),(0,s.jsx)(n.td,{children:"Always (dev proxy)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Hardcoded"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://ocapistaine.vaettir.locki.io"})}),(0,s.jsx)(n.td,{children:"Always (production proxy)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Hardcoded"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://vaettir.locki.io"})}),(0,s.jsx)(n.td,{children:"Always"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:".env"})}),(0,s.jsx)(n.td,{children:"Custom origins"}),(0,s.jsxs)(n.td,{children:["If ",(0,s.jsx)(n.code,{children:"STREAMLIT_CUSTOM_ORIGINS"})," is set"]})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"verification",children:"Verification"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"python scripts/set_streamlit_env.py\n# Output shows all configured origins\n\necho $STREAMLIT_SERVER_ALLOWED_ORIGINS\n# Comma-separated list\n"})}),"\n",(0,s.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,s.jsx)(n.h3,{id:"streamlit-cors-variables",children:"Streamlit CORS Variables"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Variable"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Set By"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_SERVER_ENABLE_CORS"})}),(0,s.jsx)(n.td,{children:"Enable CORS checking"}),(0,s.jsx)(n.td,{children:"render.yaml / script"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION"})}),(0,s.jsx)(n.td,{children:"XSRF protection (disabled behind proxy)"}),(0,s.jsx)(n.td,{children:"render.yaml / script"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_SERVER_ALLOWED_ORIGINS"})}),(0,s.jsx)(n.td,{children:"Comma-separated allowed origins"}),(0,s.jsx)(n.td,{children:"render.yaml / script"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_BROWSER_SERVER_ADDRESS"})}),(0,s.jsx)(n.td,{children:"Public domain for browser"}),(0,s.jsx)(n.td,{children:"Optional"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_BROWSER_SERVER_PORT"})}),(0,s.jsx)(n.td,{children:"Public port (443 for HTTPS)"}),(0,s.jsx)(n.td,{children:"Optional"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"input-variables",children:"Input Variables"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Variable"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Example"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"NGROK_DOMAIN"})}),(0,s.jsx)(n.td,{children:"ngrok tunnel domain (no protocol)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"my-tunnel.ngrok-free.app"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_PORT"})}),(0,s.jsx)(n.td,{children:"Local Streamlit port"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"8502"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"STREAMLIT_CUSTOM_ORIGINS"})}),(0,s.jsx)(n.td,{children:"Additional origins (comma-separated)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://custom.com"})})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"cors-errors-in-production",children:"CORS Errors in Production"}),"\n",(0,s.jsxs)(n.p,{children:["Check that ",(0,s.jsx)(n.code,{children:"render.yaml"})," includes the requesting domain in ",(0,s.jsx)(n.code,{children:"STREAMLIT_SERVER_ALLOWED_ORIGINS"}),". Redeploy after changes."]}),"\n",(0,s.jsx)(n.h3,{id:"cors-errors-in-development",children:"CORS Errors in Development"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Verify origins are set\necho $STREAMLIT_SERVER_ALLOWED_ORIGINS\n\n# If empty, run the script\neval $(python scripts/set_streamlit_env.py)\n\n# Quick test with wildcard\nexport STREAMLIT_SERVER_ALLOWED_ORIGINS="*"\nstreamlit run app/front.py\n'})}),"\n",(0,s.jsx)(n.h3,{id:"origin-not-in-allowed-list",children:"Origin Not in Allowed List"}),"\n",(0,s.jsxs)(n.p,{children:["If the browser shows ",(0,s.jsx)(n.code,{children:"origin X not in allowed origins"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Check the exact origin (including protocol and port)"}),"\n",(0,s.jsxs)(n.li,{children:["Add it to ",(0,s.jsx)(n.code,{children:"STREAMLIT_CUSTOM_ORIGINS"})," in ",(0,s.jsx)(n.code,{children:".env"})," (dev) or ",(0,s.jsx)(n.code,{children:"render.yaml"})," (prod)"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"related",children:"Related"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/app/STREAMLIT_SETUP",children:"Streamlit Setup"})," - Full setup guide"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/docs/orchestration/PROXY_MANAGEMENT",children:"Proxy Configuration"})," - Vaettir nginx proxy"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453(e,n,i){i.d(n,{R:()=>d,x:()=>l});var r=i(6540);const s={},t=r.createContext(s);function d(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);