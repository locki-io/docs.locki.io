"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[5173],{1111(e,s,n){n.r(s),n.d(s,{assets:()=>t,contentTitle:()=>d,default:()=>h,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"app/scheduler/README","title":"OCapistaine Scheduler Service","description":"Production-grade task orchestration system for civic transparency workflows.","source":"@site/docs/app/scheduler/README.md","sourceDirName":"app/scheduler","slug":"/app/scheduler/","permalink":"/docs/app/scheduler/","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/app/scheduler/README.md","tags":[],"version":"current","frontMatter":{},"sidebar":"appSidebar","previous":{"title":"Dynamic CORS Strategy for OCapistaine","permalink":"/docs/app/CORS_STRATEGY"},"next":{"title":"OCapistaine Scheduler Service","permalink":"/docs/app/scheduler/"}}');var r=n(4848),l=n(8453);const c={},d="OCapistaine Scheduler Service",t={},a=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Overview",id:"overview",level:2},{value:"Key Features",id:"key-features",level:3},{value:"Design Principles",id:"design-principles",level:3},{value:"Architecture",id:"architecture",level:2},{value:"Directory Structure",id:"directory-structure",level:3},{value:"Import Hierarchy (No Circular Dependencies)",id:"import-hierarchy-no-circular-dependencies",level:3},{value:"FastAPI Integration",id:"fastapi-integration",level:3},{value:"Task Types",id:"task-types",level:2},{value:"1. Daily Workflow Tasks (Once Per Day)",id:"1-daily-workflow-tasks-once-per-day",level:3},{value:"2. Recurring Tasks (Cron-Based)",id:"2-recurring-tasks-cron-based",level:3},{value:"Task Execution Conditions",id:"task-execution-conditions",level:2},{value:"Ollama Global Lock",id:"ollama-global-lock",level:3},{value:"Task Execution Matrix",id:"task-execution-matrix",level:3},{value:"Execution Order (Recommended Daily Timeline)",id:"execution-order-recommended-daily-timeline",level:3},{value:"Failover Chain",id:"failover-chain",level:3},{value:"Conflict Resolution",id:"conflict-resolution",level:3},{value:"Core Components",id:"core-components",level:2},{value:"1. Task Boilerplate (<code>_task_boilerplate</code>)",id:"1-task-boilerplate-_task_boilerplate",level:3},{value:"2. Scheduler Utils (<code>app/services/scheduler/utils.py</code>)",id:"2-scheduler-utils-appservicesschedulerutilspy",level:3},{value:"3. Redis Keys",id:"3-redis-keys",level:3},{value:"4. TaskError Exception",id:"4-taskerror-exception",level:3},{value:"Quick Start",id:"quick-start",level:2},{value:"Adding a New Task",id:"adding-a-new-task",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"DO",id:"do",level:3},{value:"DON&#39;T",id:"dont",level:3},{value:"Redis Usage",id:"redis-usage",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Task Not Running",id:"task-not-running",level:3},{value:"Task Runs Multiple Times",id:"task-runs-multiple-times",level:3},{value:"Ollama 404 Errors",id:"ollama-404-errors",level:3},{value:"Tasks Skipping Due to Ollama Lock",id:"tasks-skipping-due-to-ollama-lock",level:3},{value:"References",id:"references",level:2},{value:"Documentation",id:"documentation",level:3},{value:"Related Projects",id:"related-projects",level:3},{value:"Task Schedule Summary",id:"task-schedule-summary",level:2},{value:"Continuous Improvement Tasks",id:"continuous-improvement-tasks",level:2},{value:"1. Prompt Sync (<code>task_prompt_sync</code>)",id:"1-prompt-sync-task_prompt_sync",level:3},{value:"2. Audierne Docs Processing (<code>task_audierne_docs</code>)",id:"2-audierne-docs-processing-task_audierne_docs",level:3},{value:"3. Opik Evaluate (<code>task_opik_evaluate</code>)",id:"3-opik-evaluate-task_opik_evaluate",level:3},{value:"Continuous Improvement Workflow",id:"continuous-improvement-workflow",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"ocapistaine-scheduler-service",children:"OCapistaine Scheduler Service"})}),"\n",(0,r.jsx)(s.p,{children:"Production-grade task orchestration system for civic transparency workflows."}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Last Updated:"})," February 2026\n",(0,r.jsx)(s.strong,{children:"Architecture Version:"})," 1.0.0"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#overview",children:"Overview"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#architecture",children:"Architecture"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#task-types",children:"Task Types"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#core-components",children:"Core Components"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#quick-start",children:"Quick Start"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#references",children:"References"})}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(s.p,{children:"The Scheduler Service coordinates all automated workflows in OCapistaine using APScheduler with Redis-based coordination. It manages data crawling, contribution analysis, and LLM evaluation with a focus on reliability and avoiding duplicate work."}),"\n",(0,r.jsx)(s.h3,{id:"key-features",children:"Key Features"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Task Orchestration"}),": Dependency-driven task chains with sequential execution"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Distributed Locking"}),": Redis-based coordination prevents duplicate work"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Idempotency"}),": Success keys ensure tasks run once per day"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Error Handling"}),": TaskError propagation with automatic retries"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"FastAPI Integration"}),": Seamless lifespan management"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"design-principles",children:"Design Principles"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Tasks are isolated workflow units"})," - Each task file is self-contained"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Scheduler is an orchestration service"})," - Manages timing and dependencies"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"No circular dependencies"})," - Clean import hierarchy via ",(0,r.jsx)(s.code,{children:"scheduler.utils"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Shared utilities"})," - Common patterns in ",(0,r.jsx)(s.code,{children:"_task_boilerplate"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Redis coordination"})," - Lock and success keys prevent duplicate work"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"architecture",children:"Architecture"}),"\n",(0,r.jsx)(s.h3,{id:"directory-structure",children:"Directory Structure"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"app/services/\n\u251c\u2500\u2500 scheduler/              # Orchestration service\n\u2502   \u251c\u2500\u2500 __init__.py         # Main scheduler, FastAPI lifespan integration\n\u2502   \u2514\u2500\u2500 utils.py            # Shared utilities (breaks circular imports)\n\u2502\n\u2514\u2500\u2500 tasks/                  # Individual task modules\n    \u251c\u2500\u2500 __init__.py         # Task registry, _task_boilerplate\n    \u251c\u2500\u2500 task_contributions_analysis.py   # Daily contribution validation\n    \u251c\u2500\u2500 task_opik_experiment.py          # Opik dataset creation\n    \u251c\u2500\u2500 task_opik_evaluate.py            # Opik evaluation runner\n    \u251c\u2500\u2500 task_firecrawl.py                # Document crawling\n    \u251c\u2500\u2500 task_prompt_sync.py              # Prompt sync to Opik (midnight)\n    \u2514\u2500\u2500 task_audierne_docs.py            # Audierne docs processing (every 2h)\n"})}),"\n",(0,r.jsx)(s.h3,{id:"import-hierarchy-no-circular-dependencies",children:"Import Hierarchy (No Circular Dependencies)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"app/services/tasks/__init__.py\n  \u2193 defines utilities (TaskError, _task_boilerplate)\n  \u2193 imports task modules\n\napp/services/tasks/task_*.py\n  \u2193 imports from app.services.scheduler.utils\n  \u2193 (NOT from app.services.scheduler)\n\napp/services/scheduler/__init__.py\n  \u2193 imports from app.services.scheduler.utils\n  \u2193 imports from app.services.tasks\n  \u2713 No circular dependency\n"})}),"\n",(0,r.jsx)(s.h3,{id:"fastapi-integration",children:"FastAPI Integration"}),"\n",(0,r.jsx)(s.p,{children:"The scheduler integrates with FastAPI via the lifespan context manager:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"# In app/main.py\n@asynccontextmanager\nasync def lifespan(app: FastAPI):\n    # Startup\n    from app.services.scheduler import start_scheduler\n    await start_scheduler()\n\n    yield\n\n    # Shutdown\n    from app.services.scheduler import stop_scheduler\n    await stop_scheduler()\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"task-types",children:"Task Types"}),"\n",(0,r.jsx)(s.h3,{id:"1-daily-workflow-tasks-once-per-day",children:"1. Daily Workflow Tasks (Once Per Day)"}),"\n",(0,r.jsxs)(s.p,{children:["Run sequentially via ",(0,r.jsx)(s.code,{children:"orchestrate_task_chain()"})," every 7 minutes from 6 AM to 11 PM:"]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Task"}),(0,r.jsx)(s.th,{children:"Purpose"}),(0,r.jsx)(s.th,{children:"Dependencies"})]})}),(0,r.jsx)(s.tbody,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_contributions_analysis"})}),(0,r.jsx)(s.td,{children:"Validate citizen contributions"}),(0,r.jsx)(s.td,{children:"None"})]})})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Success Keys:"})," ",(0,r.jsx)(s.code,{children:"success:{task_name}:YYYYMMDD"})," (24h TTL)"]}),"\n",(0,r.jsx)(s.h3,{id:"2-recurring-tasks-cron-based",children:"2. Recurring Tasks (Cron-Based)"}),"\n",(0,r.jsx)(s.p,{children:"Run on fixed schedules:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Task"}),(0,r.jsx)(s.th,{children:"Schedule"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"orchestrate_task_chain"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"*/30 6-23 * * *"})}),(0,r.jsx)(s.td,{children:"Check/schedule daily tasks"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_firecrawl"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 3 * * *"})}),(0,r.jsx)(s.td,{children:"Nightly document crawling"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_experiment"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 5 * * *"})}),(0,r.jsx)(s.td,{children:"Daily dataset creation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_evaluate"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"*/30 7-22 * * *"})}),(0,r.jsx)(s.td,{children:"Periodic LLM evaluation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_prompt_sync"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 0 * * *"})}),(0,r.jsx)(s.td,{children:"Daily prompt sync to Opik"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_audierne_docs"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 */2 * * *"})}),(0,r.jsx)(s.td,{children:"Process audierne docs (dev)"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"task-execution-conditions",children:"Task Execution Conditions"}),"\n",(0,r.jsx)(s.p,{children:"Each task has specific execution conditions and LLM requirements. Understanding these is critical for avoiding conflicts."}),"\n",(0,r.jsx)(s.h3,{id:"ollama-global-lock",children:"Ollama Global Lock"}),"\n",(0,r.jsx)(s.p,{children:"Tasks that use local Ollama coordinate via a global Redis lock:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"lock:ollama:global  (TTL: 600s for audierne_docs)\n"})}),"\n",(0,r.jsx)(s.p,{children:"This prevents Ollama from being overwhelmed by concurrent requests."}),"\n",(0,r.jsx)(s.h3,{id:"task-execution-matrix",children:"Task Execution Matrix"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Task"}),(0,r.jsx)(s.th,{children:"LLM Provider"}),(0,r.jsx)(s.th,{children:"Ollama Lock"}),(0,r.jsx)(s.th,{children:"Failover"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_prompt_sync"})}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"No"}),(0,r.jsx)(s.td,{children:"N/A"}),(0,r.jsx)(s.td,{children:"Syncs prompts to Opik, no LLM calls"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_audierne_docs"})}),(0,r.jsx)(s.td,{children:"Ollama (default)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Acquires"})}),(0,r.jsx)(s.td,{children:"gemini"}),(0,r.jsx)(s.td,{children:"Acquires lock for 10min, falls back to gemini if locked"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_evaluate"})}),(0,r.jsx)(s.td,{children:"Gemini (default)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Checks"})}),(0,r.jsx)(s.td,{children:"gemini"}),(0,r.jsx)(s.td,{children:"Checks lock if using ollama, auto-failover"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_experiment"})}),(0,r.jsx)(s.td,{children:"Ollama (default)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Checks"})}),(0,r.jsx)(s.td,{children:"gemini"}),(0,r.jsx)(s.td,{children:"Checks lock if using ollama"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_contributions_analysis"})}),(0,r.jsx)(s.td,{children:"Configurable"}),(0,r.jsx)(s.td,{children:"Optional"}),(0,r.jsx)(s.td,{children:"Yes"}),(0,r.jsx)(s.td,{children:"Supports full failover chain"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_firecrawl"})}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"No"}),(0,r.jsx)(s.td,{children:"N/A"}),(0,r.jsx)(s.td,{children:"Web crawling only, no LLM"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"execution-order-recommended-daily-timeline",children:"Execution Order (Recommended Daily Timeline)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"00:00  task_prompt_sync        [No LLM] Sync prompts to Opik\n03:00  task_firecrawl          [No LLM] Crawl municipal documents\n05:00  task_opik_experiment    [Ollama/Gemini] Create evaluation datasets\n06:00+ task_chain              [Various] Daily contribution analysis\n07:00+ task_opik_evaluate      [Gemini] Run evaluations (every 30min)\n*:00   task_audierne_docs      [Ollama/Gemini] Process docs (every 2h)\n"})}),"\n",(0,r.jsx)(s.h3,{id:"failover-chain",children:"Failover Chain"}),"\n",(0,r.jsx)(s.p,{children:"When Ollama is unavailable or locked, tasks automatically fail over:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"ollama \u2192 openai \u2192 claude \u2192 mistral \u2192 gemini\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," Gemini is last due to aggressive rate limits (20 req/day on free tier)."]}),"\n",(0,r.jsx)(s.p,{children:"Failover is enabled by default for most tasks. Configuration:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'# In task call\nresult = task_audierne_docs(\n    enable_failover=True,   # Use gemini if ollama locked\n    provider="ollama",      # Primary provider\n)\n'})}),"\n",(0,r.jsx)(s.h3,{id:"conflict-resolution",children:"Conflict Resolution"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," ",(0,r.jsx)(s.code,{children:"task_audierne_docs"})," is processing a large document with Ollama (holds lock for 10 min)"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Meanwhile:"})," ",(0,r.jsx)(s.code,{children:"task_opik_evaluate"})," triggers at :30"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Resolution:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"task_opik_evaluate"})," checks ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})]}),"\n",(0,r.jsx)(s.li,{children:"Lock exists \u2192 task uses gemini instead"}),"\n",(0,r.jsx)(s.li,{children:"Both tasks complete successfully without conflicts"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Manual Override:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# Clear Ollama lock if stuck\nredis-cli -n 6 DEL \"lock:ollama:global\"\n\n# Force task to skip failover\npython -c \"\nfrom app.services.scheduler import run_task_now\nresult = run_task_now('task_audierne_docs', provider='ollama', enable_failover=False)\n\"\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"core-components",children:"Core Components"}),"\n",(0,r.jsxs)(s.h3,{id:"1-task-boilerplate-_task_boilerplate",children:["1. Task Boilerplate (",(0,r.jsx)(s.code,{children:"_task_boilerplate"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Location:"})," ",(0,r.jsx)(s.code,{children:"app/services/tasks/__init__.py"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Purpose:"})," Eliminates repetitive code in every task (lock, success key, result dict)."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Usage:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from app.services.tasks import _task_boilerplate, TaskError\n\nl, lock_key, success_key, result, task_id = _task_boilerplate(\n    "task_name", date_string, skip_success_check=False\n)\n\nif result["status"] == "skipped":\n    return result  # Already completed or running\n'})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Returns:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"l"}),": Redis connection (db=6)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"lock_key"}),": ",(0,r.jsx)(s.code,{children:"lock:task_name:YYYYMMDD"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"success_key"}),": ",(0,r.jsx)(s.code,{children:"success:task_name:YYYYMMDD"})]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"result"}),": Pre-initialized dict with status, errors, warnings"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"task_id"}),": Unique UUID for this execution"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Parameters:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"skip_success_check"}),": Set ",(0,r.jsx)(s.code,{children:"True"})," for recurring tasks (default: ",(0,r.jsx)(s.code,{children:"False"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(s.h3,{id:"2-scheduler-utils-appservicesschedulerutilspy",children:["2. Scheduler Utils (",(0,r.jsx)(s.code,{children:"app/services/scheduler/utils.py"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Purpose:"})," Shared utilities to avoid circular imports between scheduler and tasks."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Functions:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'def get_scheduler_redis() -> redis.Redis:\n    """Get Redis connection for scheduler locks (db=6)."""\n    ...\n\ndef normalize_timestamp(ts: int | float) -> int:\n    """Convert millisecond timestamps to seconds."""\n    ...\n\ndef clear_old_jobs(scheduler, prefix: str = "task_") -> int:\n    """Remove stale jobs with given prefix."""\n    ...\n'})}),"\n",(0,r.jsx)(s.h3,{id:"3-redis-keys",children:"3. Redis Keys"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Task Lock Keys"})," (TTL: 300 seconds):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"lock:task_contributions_analysis:20260206\nlock:task_firecrawl:20260206\nlock:task_opik_experiment:20260206\nlock:task_opik_evaluate:20260206\nlock:task_prompt_sync:20260206\nlock:task_audierne_docs:20260206\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Success Keys"})," (TTL: 86400 seconds):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"success:task_contributions_analysis:20260206\nsuccess:task_firecrawl:20260206\nsuccess:task_opik_experiment:20260206\nsuccess:task_opik_evaluate:20260206\nsuccess:task_prompt_sync:20260206\nsuccess:task_audierne_docs:20260206\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Resource Lock Keys"})," (global, not date-based):"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"lock:ollama:global   (TTL: 600s) - Prevents concurrent Ollama usage\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Purpose:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Task locks"}),": Prevent concurrent execution of the same task (distributed locking)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Success keys"}),": Enable idempotency (skip if already completed)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Resource locks"}),": Prevent concurrent usage of shared resources (Ollama)"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"4-taskerror-exception",children:"4. TaskError Exception"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'class TaskError(Exception):\n    """Custom exception for task failures."""\n\n    def __init__(self, status: str, message: str):\n        self.status = status\n        self.message = message\n        super().__init__(message)\n'})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Usage:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'try:\n    result = fetch_data()\n    if not result:\n        raise TaskError("failed", "No data returned from API")\nexcept RequestException as e:\n    raise TaskError("failed", f"API request failed: {e}")\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,r.jsx)(s.h3,{id:"adding-a-new-task",children:"Adding a New Task"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"1. Create task file:"})," ",(0,r.jsx)(s.code,{children:"app/services/tasks/task_mynewtask.py"})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"2. Use boilerplate pattern:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from app.services.tasks import TaskError, _task_boilerplate, REDIS_SUCCESS_TTL\n\ndef task_mynewtask(date_string: str = None) -> dict:\n    l, lock_key, success_key, result, task_id = _task_boilerplate(\n        "task_mynewtask", date_string\n    )\n\n    if result["status"] == "skipped":\n        return result\n\n    try:\n        # Your logic here\n        result["status"] = "success"\n        l.set(success_key, "completed", ex=REDIS_SUCCESS_TTL)\n        return result\n    except Exception as e:\n        result["status"] = "failed"\n        result["errors"].append(str(e))\n        raise TaskError("failed", str(e))\n    finally:\n        l.delete(lock_key)\n'})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"3. Export from task registry:"})," ",(0,r.jsx)(s.code,{children:"app/services/tasks/__init__.py"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"4. Schedule in orchestrator:"})," ",(0,r.jsx)(s.code,{children:"app/services/scheduler/__init__.py"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"See:"})," ",(0,r.jsx)(s.a,{href:"/docs/app/scheduler/USAGE_EXAMPLES",children:"USAGE_EXAMPLES.md"})," for complete examples."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,r.jsx)(s.h3,{id:"do",children:"DO"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Use ",(0,r.jsx)(s.code,{children:"_task_boilerplate"})," for consistency"]}),"\n",(0,r.jsx)(s.li,{children:"Return standardized result dict"}),"\n",(0,r.jsx)(s.li,{children:"Mark task as completed with success key"}),"\n",(0,r.jsxs)(s.li,{children:["Release lock in ",(0,r.jsx)(s.code,{children:"finally"})," block"]}),"\n",(0,r.jsx)(s.li,{children:"Log errors with full context"}),"\n",(0,r.jsx)(s.li,{children:"Keep tasks idempotent"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"dont",children:"DON'T"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Skip lock acquisition (causes duplicate work)"}),"\n",(0,r.jsx)(s.li,{children:"Forget to release lock (blocks future runs)"}),"\n",(0,r.jsxs)(s.li,{children:["Raise generic ",(0,r.jsx)(s.code,{children:"Exception"})," (use ",(0,r.jsx)(s.code,{children:"TaskError"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:["Import from ",(0,r.jsx)(s.code,{children:"app.services.scheduler"})," in tasks (use ",(0,r.jsx)(s.code,{children:"scheduler.utils"}),")"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"redis-usage",children:"Redis Usage"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from app.services.scheduler.utils import get_scheduler_redis\n\n# Scheduler locks (db=6)\nl = get_scheduler_redis()\nl.set("lock:task_name:20260203", task_id, ex=300, nx=True)\n\n# Application data (db=5, via redis_client)\nfrom app.data.redis_client import redis_connection\nwith redis_connection() as r:\n    r.setex("contribution:abc123", 86400, json.dumps(data))\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(s.h3,{id:"task-not-running",children:"Task Not Running"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Scheduler running: ",(0,r.jsx)(s.code,{children:"scheduler.running == True"})]}),"\n",(0,r.jsxs)(s.li,{children:["Task scheduled: ",(0,r.jsx)(s.code,{children:"scheduler.get_jobs()"})]}),"\n",(0,r.jsxs)(s.li,{children:["Lock held: ",(0,r.jsx)(s.code,{children:'redis-cli -n 6 KEYS "lock:task_name:*"'})]}),"\n",(0,r.jsxs)(s.li,{children:["Already completed: ",(0,r.jsx)(s.code,{children:'redis-cli -n 6 KEYS "success:task_name:*"'})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# Clear stuck lock\nredis-cli -n 6 DEL "lock:task_contributions_analysis:20260203"\n\n# Re-run task\nredis-cli -n 6 DEL "success:task_contributions_analysis:20260203"\n'})}),"\n",(0,r.jsx)(s.h3,{id:"task-runs-multiple-times",children:"Task Runs Multiple Times"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Cause:"})," Lock not acquired properly or released prematurely."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Fix:"})," Always use ",(0,r.jsx)(s.code,{children:"_task_boilerplate"})," and release lock in ",(0,r.jsx)(s.code,{children:"finally"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'l, lock_key, success_key, result, task_id = _task_boilerplate(...)\n\nif result["status"] == "skipped":\n    return result\n\ntry:\n    # Task logic\n    pass\nfinally:\n    l.delete(lock_key)  # CRITICAL: Always release\n'})}),"\n",(0,r.jsx)(s.h3,{id:"ollama-404-errors",children:"Ollama 404 Errors"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Symptom:"})," Tasks fail with ",(0,r.jsx)(s.code,{children:"Client error '404 Not Found' for url 'http://localhost:11434/api/chat'"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Cause:"})," Ollama is not running or is busy with another request."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# 1. Check if Ollama is running\ncurl http://localhost:11434/api/tags\n\n# 2. Start Ollama if not running\nollama serve\n\n# 3. Check if Ollama lock is held\nredis-cli -n 6 GET "lock:ollama:global"\n\n# 4. Clear stuck lock if needed\nredis-cli -n 6 DEL "lock:ollama:global"\n'})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Prevention:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Tasks now use automatic failover to gemini when Ollama is unavailable"}),"\n",(0,r.jsxs)(s.li,{children:["The ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})," key prevents concurrent Ollama usage"]}),"\n",(0,r.jsxs)(s.li,{children:["Check ",(0,r.jsx)(s.code,{children:'result["provider_used"]'})," to see which provider was actually used"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"tasks-skipping-due-to-ollama-lock",children:"Tasks Skipping Due to Ollama Lock"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Symptom:"})," Task returns ",(0,r.jsx)(s.code,{children:"status=skipped, reason=ollama_locked"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Cause:"})," Another task holds the Ollama lock."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Normal behavior:"})," Tasks fail over to gemini automatically."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"If not using failover:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# Check what\'s holding the lock\nredis-cli -n 6 GET "lock:ollama:global"\n\n# Check TTL remaining\nredis-cli -n 6 TTL "lock:ollama:global"\n\n# Wait for lock to expire (max 10 min for audierne_docs)\n# Or clear manually if stuck:\nredis-cli -n 6 DEL "lock:ollama:global"\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"references",children:"References"}),"\n",(0,r.jsx)(s.h3,{id:"documentation",children:"Documentation"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.a,{href:"/docs/app/scheduler/USAGE_EXAMPLES",children:"USAGE_EXAMPLES.md"})})," - Complete how-to guide with code examples"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.a,{href:"/docs/app/scheduler/TASK_BOILERPLATE",children:"TASK_BOILERPLATE.md"})})," - Detailed boilerplate usage"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"related-projects",children:"Related Projects"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Vaettir"})," (github.com/locki-io/vaettir) - N8N workflows for decision-making"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"audierne2026/participons"})," - Public participation platform"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"task-schedule-summary",children:"Task Schedule Summary"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Task"}),(0,r.jsx)(s.th,{children:"Schedule"}),(0,r.jsx)(s.th,{children:"LLM"}),(0,r.jsx)(s.th,{children:"Lock"}),(0,r.jsx)(s.th,{children:"Purpose"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_prompt_sync"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 0 * * *"})}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"Task"}),(0,r.jsx)(s.td,{children:"Daily prompt sync to Opik"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_firecrawl"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 3 * * *"})}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"Task"}),(0,r.jsx)(s.td,{children:"Nightly document crawling"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_experiment"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 5 * * *"})}),(0,r.jsx)(s.td,{children:"Ollama/Gemini"}),(0,r.jsx)(s.td,{children:"Check"}),(0,r.jsx)(s.td,{children:"Daily Opik dataset creation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"orchestrate_task_chain"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"*/30 6-23 * * *"})}),(0,r.jsx)(s.td,{children:"Various"}),(0,r.jsx)(s.td,{children:"Task"}),(0,r.jsx)(s.td,{children:"Dependency-driven task orchestration"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_contributions_analysis"})}),(0,r.jsx)(s.td,{children:"Via chain"}),(0,r.jsx)(s.td,{children:"Configurable"}),(0,r.jsx)(s.td,{children:"Task"}),(0,r.jsx)(s.td,{children:"Daily contribution validation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_opik_evaluate"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"*/30 7-22 * * *"})}),(0,r.jsx)(s.td,{children:"Gemini"}),(0,r.jsx)(s.td,{children:"Check"}),(0,r.jsx)(s.td,{children:"Periodic LLM evaluation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"task_audierne_docs"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"0 */2 * * *"})}),(0,r.jsx)(s.td,{children:"Ollama/Gemini"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Acquire"})}),(0,r.jsx)(s.td,{children:"Process audierne docs (dev)"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Lock column:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Task"}),": Standard task lock only"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Check"}),": Checks ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})," before using Ollama"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Acquire"}),": Acquires ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})," for duration"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"continuous-improvement-tasks",children:"Continuous Improvement Tasks"}),"\n",(0,r.jsx)(s.p,{children:"Three key tasks support the continuous improvement workflow:"}),"\n",(0,r.jsxs)(s.h3,{id:"1-prompt-sync-task_prompt_sync",children:["1. Prompt Sync (",(0,r.jsx)(s.code,{children:"task_prompt_sync"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Schedule:"})," Daily at midnight (",(0,r.jsx)(s.code,{children:"0 0 * * *"}),")\n",(0,r.jsx)(s.strong,{children:"LLM:"})," None (metadata sync only)\n",(0,r.jsx)(s.strong,{children:"Lock:"})," Task lock only"]}),"\n",(0,r.jsx)(s.p,{children:"Synchronizes local prompts to Opik platform for version tracking and A/B testing:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Individual prompts (",(0,r.jsx)(s.code,{children:"forseti.*"}),") synced as ",(0,r.jsx)(s.code,{children:"text"})," type"]}),"\n",(0,r.jsxs)(s.li,{children:["Composite prompts (",(0,r.jsx)(s.code,{children:"forseti-persona-*"}),") synced as ",(0,r.jsx)(s.code,{children:"chat"})," type"]}),"\n",(0,r.jsx)(s.li,{children:"Enables prompt optimization via Opik studio"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["See: ",(0,r.jsx)(s.a,{href:"/docs/app/scheduler/tasks/TASK_PROMPT_SYNC",children:"TASK_PROMPT_SYNC.md"})]}),"\n",(0,r.jsxs)(s.h3,{id:"2-audierne-docs-processing-task_audierne_docs",children:["2. Audierne Docs Processing (",(0,r.jsx)(s.code,{children:"task_audierne_docs"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Schedule:"})," Every 2 hours (",(0,r.jsx)(s.code,{children:"0 */2 * * *"}),") - Development mode\n",(0,r.jsx)(s.strong,{children:"LLM:"})," Ollama (default) with gemini failover\n",(0,r.jsx)(s.strong,{children:"Lock:"})," Acquires ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})," (TTL: 600s)"]}),"\n",(0,r.jsx)(s.p,{children:"Processes audierne2026 markdown documents to build training datasets:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"One document per run (prevents overload)"}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Acquires Ollama lock"})," before processing (10 min TTL)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Fails over to gemini"})," if Ollama is locked/unavailable"]}),"\n",(0,r.jsx)(s.li,{children:"Extracts themes using LLM chunking (15k chars, 500 overlap)"}),"\n",(0,r.jsx)(s.li,{children:"Generates contributions with violations"}),"\n",(0,r.jsx)(s.li,{children:"Creates Opik dataset per document"}),"\n",(0,r.jsxs)(s.li,{children:["Progress tracked in ",(0,r.jsx)(s.code,{children:"docs/docs/audierne2026/PROCESSING_PROGRESS.md"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Progress File Example:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-markdown",children:"| File | Status | Themes | Contributions | Dataset |\n|------|--------|--------|---------------|---------|\n| MVP-meeting-satellite.md | \u2705 Done | 3 | 12 | audierne-MVP-meeting-satellite-20260206 |\n| MVP_meeting.md | \u23f3 Pending | - | - | - |\n"})}),"\n",(0,r.jsxs)(s.p,{children:["See: ",(0,r.jsx)(s.a,{href:"/docs/app/scheduler/tasks/TASK_AUDIERNE_DOCS",children:"TASK_AUDIERNE_DOCS.md"})]}),"\n",(0,r.jsxs)(s.h3,{id:"3-opik-evaluate-task_opik_evaluate",children:["3. Opik Evaluate (",(0,r.jsx)(s.code,{children:"task_opik_evaluate"}),")"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Schedule:"})," Every 30 minutes (",(0,r.jsx)(s.code,{children:"*/30 7-22 * * *"}),")\n",(0,r.jsx)(s.strong,{children:"LLM:"})," Gemini (default)\n",(0,r.jsx)(s.strong,{children:"Lock:"})," Checks ",(0,r.jsx)(s.code,{children:"lock:ollama:global"})," if using ollama"]}),"\n",(0,r.jsx)(s.p,{children:"Evaluates LLM outputs using Opik metrics:"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Checks Ollama lock"})," before using (if configured for ollama)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Auto-failover to gemini"})," if Ollama is locked"]}),"\n",(0,r.jsx)(s.li,{children:"Runs hallucination and output_format metrics"}),"\n",(0,r.jsx)(s.li,{children:"Creates evaluation datasets from recent spans"}),"\n",(0,r.jsx)(s.li,{children:"Reports results to Opik dashboard"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Important:"})," This task defaults to ",(0,r.jsx)(s.code,{children:"gemini"})," to avoid conflicts with ",(0,r.jsx)(s.code,{children:"task_audierne_docs"}),"."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"continuous-improvement-workflow",children:"Continuous Improvement Workflow"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Continuous Improvement Loop                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                 \u2502\n\u2502  task_prompt_sync (midnight) [No LLM]                           \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Prompts synced to Opik                                         \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  task_audierne_docs (every 2h) [Ollama \u2192 Gemini failover]       \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Generate contributions from real docs (acquires Ollama lock)   \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Create Opik dataset per document                               \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  task_opik_evaluate (every 30min) [Gemini - avoids conflict]    \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Evaluate Forseti accuracy                                      \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Opik Optimizer                                                 \u2502\n\u2502        \u2193                                                        \u2502\n\u2502  Improved prompts \u2192 task_prompt_sync (next midnight)            \u2502\n\u2502                                                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Last Updated:"})," February 2026\n",(0,r.jsx)(s.strong,{children:"Maintained by:"})," OCapistaine Team\n",(0,r.jsx)(s.strong,{children:"Architecture Version:"})," 1.2.0"]})]})}function h(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,s,n){n.d(s,{R:()=>c,x:()=>d});var i=n(6540);const r={},l=i.createContext(r);function c(e){const s=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),i.createElement(l.Provider,{value:s},e.children)}}}]);