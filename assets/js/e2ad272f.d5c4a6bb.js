"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[8108],{96(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"agents/forseti/ARCHITECTURE","title":"Forseti 461 Architecture","description":"Technical documentation for the Forseti 461 agent implementation.","source":"@site/docs/agents/forseti/ARCHITECTURE.md","sourceDirName":"agents/forseti","slug":"/agents/forseti/ARCHITECTURE","permalink":"/docs/agents/forseti/ARCHITECTURE","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/agents/forseti/ARCHITECTURE.md","tags":[],"version":"current","frontMatter":{}}');var i=t(4848),a=t(8453);const s={},o="Forseti 461 Architecture",l={},c=[{value:"Directory Structure",id:"directory-structure",level:2},{value:"Core Concepts",id:"core-concepts",level:2},{value:"Provider Abstraction",id:"provider-abstraction",level:3},{value:"Feature Composition",id:"feature-composition",level:3},{value:"Prompt Separation",id:"prompt-separation",level:3},{value:"Data Flow",id:"data-flow",level:2},{value:"Pydantic Models",id:"pydantic-models",level:2},{value:"Core Models",id:"core-models",level:3},{value:"Batch Models",id:"batch-models",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Environment Variables",id:"environment-variables",level:3},{value:"ProviderConfig",id:"providerconfig",level:3},{value:"Tracing",id:"tracing",level:2},{value:"Automatic Feature Tracing",id:"automatic-feature-tracing",level:3},{value:"Manual Tracing",id:"manual-tracing",level:3},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing",id:"testing",level:2},{value:"Migration from Legacy",id:"migration-from-legacy",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"forseti-461-architecture",children:"Forseti 461 Architecture"})}),"\n",(0,i.jsx)(n.p,{children:"Technical documentation for the Forseti 461 agent implementation."}),"\n",(0,i.jsx)(n.h2,{id:"directory-structure",children:"Directory Structure"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"app/\n\u251c\u2500\u2500 providers/                 # LLM Provider Abstraction\n\u2502   \u251c\u2500\u2500 __init__.py           # Factory: get_provider()\n\u2502   \u251c\u2500\u2500 base.py               # LLMProvider ABC, Message, CompletionResponse\n\u2502   \u251c\u2500\u2500 config.py             # ProviderConfig (pydantic-settings)\n\u2502   \u251c\u2500\u2500 gemini.py             # Google Gemini\n\u2502   \u251c\u2500\u2500 claude.py             # Anthropic Claude\n\u2502   \u251c\u2500\u2500 mistral.py            # Mistral AI\n\u2502   \u2514\u2500\u2500 ollama.py             # Local Ollama\n\u2502\n\u251c\u2500\u2500 agents/\n\u2502   \u251c\u2500\u2500 __init__.py           # Exports BaseAgent, AgentFeature\n\u2502   \u251c\u2500\u2500 base.py               # BaseAgent with feature composition\n\u2502   \u251c\u2500\u2500 tracing/\n\u2502   \u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2502   \u2514\u2500\u2500 opik.py           # AgentTracer, trace_feature decorator\n\u2502   \u2514\u2500\u2500 forseti/\n\u2502       \u251c\u2500\u2500 __init__.py\n\u2502       \u251c\u2500\u2500 agent.py          # ForsetiAgent class\n\u2502       \u251c\u2500\u2500 prompts.py        # PERSONA_PROMPT, feature prompts\n\u2502       \u251c\u2500\u2500 models.py         # Pydantic models\n\u2502       \u2514\u2500\u2500 features/\n\u2502           \u251c\u2500\u2500 __init__.py\n\u2502           \u251c\u2500\u2500 base.py       # FeatureBase ABC\n\u2502           \u251c\u2500\u2500 charter_validation.py\n\u2502           \u251c\u2500\u2500 category_classification.py\n\u2502           \u2514\u2500\u2500 wording_correction.py\n\u2502\n\u2514\u2500\u2500 api/routes/\n    \u2514\u2500\u2500 validate.py           # REST API endpoints\n"})}),"\n",(0,i.jsx)(n.h2,{id:"core-concepts",children:"Core Concepts"}),"\n",(0,i.jsx)(n.h3,{id:"provider-abstraction",children:"Provider Abstraction"}),"\n",(0,i.jsxs)(n.p,{children:["All LLM providers implement the ",(0,i.jsx)(n.code,{children:"LLMProvider"})," abstract base class:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class LLMProvider(ABC):\n    @property\n    def name(self) -> str: ...\n    @property\n    def model(self) -> str: ...\n\n    async def complete(\n        self,\n        messages: list[Message],\n        temperature: float = 0.7,\n        max_tokens: int | None = None,\n        json_mode: bool = False,\n    ) -> CompletionResponse: ...\n\n    async def stream(\n        self,\n        messages: list[Message],\n        temperature: float = 0.7,\n        max_tokens: int | None = None,\n    ) -> AsyncIterator[str]: ...\n"})}),"\n",(0,i.jsx)(n.p,{children:"Use the factory to get providers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from app.providers import get_provider\n\n# Default provider (from DEFAULT_PROVIDER env var)\nprovider = get_provider()\n\n# Specific provider\nprovider = get_provider("claude")\n\n# With custom settings\nprovider = get_provider("gemini", api_key="...", model="gemini-1.5-pro")\n'})}),"\n",(0,i.jsx)(n.h3,{id:"feature-composition",children:"Feature Composition"}),"\n",(0,i.jsxs)(n.p,{children:["Agents are composed of features that implement the ",(0,i.jsx)(n.code,{children:"AgentFeature"})," protocol:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"@runtime_checkable\nclass AgentFeature(Protocol):\n    @property\n    def name(self) -> str: ...\n\n    @property\n    def prompt(self) -> str: ...\n\n    async def execute(\n        self,\n        provider: LLMProvider,\n        system_prompt: str,\n        **kwargs,\n    ) -> Any: ...\n"})}),"\n",(0,i.jsx)(n.p,{children:"Features are registered with agents and executed independently:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class ForsetiAgent(BaseAgent):\n    def __init__(self):\n        super().__init__()\n        self.register_feature(CharterValidationFeature())\n        self.register_feature(CategoryClassificationFeature())\n\n        if enable_wording:\n            self.register_feature(WordingCorrectionFeature())\n\n    # Execute specific feature\n    result = await agent.execute_feature("charter_validation", title="...", body="...")\n\n    # Execute all features\n    results = await agent.execute_all(title="...", body="...")\n'})}),"\n",(0,i.jsx)(n.h3,{id:"prompt-separation",children:"Prompt Separation"}),"\n",(0,i.jsx)(n.p,{children:"Prompts are separated into:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Persona Prompt"})," (system message): Defines WHO the agent is"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Identity, values, response style"}),"\n",(0,i.jsx)(n.li,{children:"Shared across all features"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Feature Prompts"})," (user message): Defines WHAT to do"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Specific task instructions"}),"\n",(0,i.jsx)(n.li,{children:"Expected output format"}),"\n",(0,i.jsx)(n.li,{children:"Feature-specific context"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Persona (system prompt)\nPERSONA_PROMPT = """You are Forseti 461, the impartial guardian..."""\n\n# Feature prompt (user prompt)\nCHARTER_VALIDATION_PROMPT = """Validate this contribution...\nTITLE: {title}\nBODY: {body}\nReturn JSON: {"is_valid": ..., "violations": [...]}"""\n'})}),"\n",(0,i.jsx)(n.h2,{id:"data-flow",children:"Data Flow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"                                  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                  \u2502   REST API      \u2502\n                                  \u2502 /api/v1/validate\u2502\n                                  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                           \u2502\n                                           \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      ForsetiAgent                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  Persona    \u2502  \u2502  Features   \u2502  \u2502      Provider       \u2502  \u2502\n\u2502  \u2502  Prompt     \u2502  \u2502             \u2502  \u2502  (Gemini/Claude/...)\u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                   \u2502 \u2502Charter  \u2502 \u2502                            \u2502\n\u2502                   \u2502 \u2502Validation\u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                  \u2502\n\u2502                   \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502          \u2502                 \u2502\n\u2502                   \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502          \u25bc                 \u2502\n\u2502                   \u2502 \u2502Category \u2502 \u2502    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u2502\n\u2502                   \u2502 \u2502Classify \u2502\u2500\u2500\u2500\u2500\u2500\u25b6\u2502  LLM     \u2502            \u2502\n\u2502                   \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502    \u2502 Provider \u2502            \u2502\n\u2502                   \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2502\n\u2502                   \u2502 \u2502Wording  \u2502 \u2502          \u2502                 \u2502\n\u2502                   \u2502 \u2502Correct  \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502                   \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502                            \u2502\n\u2502                   \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                           \u2502\n                                           \u25bc\n                                  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n                                  \u2502  AgentTracer    \u2502\n                                  \u2502    (Opik)       \u2502\n                                  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h2,{id:"pydantic-models",children:"Pydantic Models"}),"\n",(0,i.jsx)(n.h3,{id:"core-models",children:"Core Models"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class ValidationResult(BaseModel):\n    is_valid: bool\n    violations: list[str]\n    encouraged_aspects: list[str]\n    reasoning: str\n    confidence: float  # 0.0 - 1.0\n\nclass ClassificationResult(BaseModel):\n    category: str  # One of CATEGORIES\n    reasoning: str\n    confidence: float\n\nclass FullValidationResult(BaseModel):\n    is_valid: bool\n    category: str\n    original_category: str | None\n    violations: list[str]\n    encouraged_aspects: list[str]\n    reasoning: str\n    confidence: float\n"})}),"\n",(0,i.jsx)(n.h3,{id:"batch-models",children:"Batch Models"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class BatchItem(BaseModel):\n    id: str\n    title: str\n    body: str\n    category: str | None\n\nclass BatchResult(BaseModel):\n    id: str\n    is_valid: bool\n    violations: list[str]\n    encouraged_aspects: list[str]\n    category: str\n    reasoning: str\n    confidence: float\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Provider selection\nDEFAULT_PROVIDER=gemini  # gemini | claude | mistral | ollama\n\n# Gemini\nGOOGLE_API_KEY=...\nGEMINI_MODEL=gemini-1.5-flash\nGEMINI_RATE_LIMIT=12.0  # seconds between calls\n\n# Claude\nANTHROPIC_API_KEY=...\nCLAUDE_MODEL=claude-3-haiku-20240307\n\n# Mistral\nMISTRAL_API_KEY=...\nMISTRAL_MODEL=mistral-small-latest\n\n# Ollama\nOLLAMA_HOST=http://localhost:11434\nOLLAMA_MODEL=mistral:latest\n\n# Tracing\nOPIK_API_KEY=...\nOPIK_WORKSPACE=...\nOPIK_PROJECT=forseti\n"})}),"\n",(0,i.jsx)(n.h3,{id:"providerconfig",children:"ProviderConfig"}),"\n",(0,i.jsx)(n.p,{children:"Configuration is managed via pydantic-settings:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from app.providers.config import get_config\n\nconfig = get_config()\nprint(config.default_provider)  # "gemini"\nprint(config.gemini_model)      # "gemini-1.5-flash"\n'})}),"\n",(0,i.jsx)(n.h2,{id:"tracing",children:"Tracing"}),"\n",(0,i.jsx)(n.h3,{id:"automatic-feature-tracing",children:"Automatic Feature Tracing"}),"\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"@trace_feature"})," decorator:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from app.agents.tracing import trace_feature\n\nclass MyFeature(FeatureBase):\n    @trace_feature("my_feature")\n    async def execute(self, provider, system_prompt, **kwargs):\n        # Automatically traced\n        return result\n'})}),"\n",(0,i.jsx)(n.h3,{id:"manual-tracing",children:"Manual Tracing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from app.agents.tracing import get_tracer\n\ntracer = get_tracer()\ntracer.trace(\n    name="custom_operation",\n    input={"title": "..."},\n    output={"is_valid": True},\n    metadata={"confidence": 0.95},\n    tags=["forseti", "custom"],\n)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"Features fail gracefully with safe defaults:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Charter validation: fail open (allow content through)\nexcept Exception as e:\n    return ValidationResult(\n        is_valid=True,  # Fail open\n        violations=[],\n        reasoning=f"Validation error: {e}",\n        confidence=0.5,\n    )\n\n# Category classification: use default category\nexcept Exception as e:\n    return ClassificationResult(\n        category=current_category or CATEGORIES[0],  # Default to first\n        reasoning=f"Classification error: {e}",\n        confidence=0.5,\n    )\n'})}),"\n",(0,i.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Run all tests\npoetry run pytest tests/test_providers/ tests/test_agents/\n\n# Test specific provider\npoetry run pytest tests/test_providers/test_gemini.py\n\n# Test Forseti agent\npoetry run pytest tests/test_agents/test_forseti.py\n"})}),"\n",(0,i.jsx)(n.h2,{id:"migration-from-legacy",children:"Migration from Legacy"}),"\n",(0,i.jsx)(n.p,{children:"The new implementation maintains backward compatibility:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Old way (still works via charterAgent/)\nfrom charterAgent.charter_agent import validate_issue\nresult = validate_issue(title="...", body="...")\n\n# New way (preferred)\nfrom app.agents.forseti import ForsetiAgent\nagent = ForsetiAgent()\nresult = await agent.validate(title="...", body="...")\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"charterAgent/validate_repo.py"})," script automatically uses the new agent when available."]})]})}function p(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>o});var r=t(6540);const i={},a=r.createContext(i);function s(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);