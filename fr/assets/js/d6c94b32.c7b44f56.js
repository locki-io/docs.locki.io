"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[9924],{8453(e,n,t){t.d(n,{R:()=>a,x:()=>s});var o=t(6540);const i={},r=o.createContext(i);function a(e){const n=o.useContext(r);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(r.Provider,{value:n},e.children)}},8454(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>p,frontMatter:()=>a,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"ARCHITECTURE","title":"ARCHITECTURE","description":"Step 3: Configure Opik in Your Code","source":"@site/docs/ARCHITECTURE.md","sourceDirName":".","slug":"/ARCHITECTURE","permalink":"/fr/docs/ARCHITECTURE","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/ARCHITECTURE.md","tags":[],"version":"current","frontMatter":{}}');var i=t(4848),r=t(8453);const a={},s=void 0,c={},l=[{value:"Step 3: Configure Opik in Your Code",id:"step-3-configure-opik-in-your-code",level:2},{value:"Option A \u2705 : Environment Variables (recommended for production/security)",id:"option-a---environment-variables-recommended-for-productionsecurity",level:3},{value:"Step 4: Instrument Your Code",id:"step-4-instrument-your-code",level:2},{value:"Example: Tracing a Crawling Function",id:"example-tracing-a-crawling-function",level:3},{value:"Example: Tracing LLM/Agent Calls",id:"example-tracing-llmagent-calls",level:3},{value:"Example: Tracing FastAPI Endpoints",id:"example-tracing-fastapi-endpoints",level:3},{value:"Step 5: Run and Test",id:"step-5-run-and-test",level:2},{value:"Advanced: Adding Evaluations",id:"advanced-adding-evaluations",level:2},{value:"Switching to Self-Hosted Opik (Later/Production)",id:"switching-to-self-hosted-opik-laterproduction",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-markdown",children:"# Ocapistaine Project\n\nA Python-based crawling and AI agent system (built with FastAPI and related tools) for gathering, processing, and responding to civic contributions. This README focuses on integrating **Opik** (from Comet ML) for LLM tracing, evaluation, and observability.\n\nOpik provides powerful tracing for LLM calls, agent workflows, and crawling operations, helping you monitor performance, detect hallucinations, and evaluate outputs. We'll start with the **cloud-hosted version** (free tier on Comet) for quick testing and iteration, then outline how to switch to self-hosted later.\n\n## Why Opik?\n\n- Automatic tracing of LLM calls, agent steps, and custom functions (e.g., your crawling logic).\n- Built-in evaluations (hallucination, relevance, moderation checks).\n- Dashboard for visualizing traces, datasets, and metrics.\n- Privacy-friendly: You control what data is logged.\n\n## Prerequisites\n\n- Python 3.9+ -> 3.13\n- A Comet account (free tier sufficient for testing)\n- Your project dependencies (e.g., FastAPI, requests, langchain/crewai if used for agents)\n\n## Step 1: Sign Up for Comet Opik Cloud\n\n1. \u2705Go to [https://www.comet.com/signup](https://www.comet.com/signup) and create a free account.\n2. \u2705 After logging in, navigate to **Opik** section (or directly to [https://www.comet.com/opik](https://www.comet.com/opik)).\n3. \u2705 Create a new workspace (ocapistaine-dev). with a dashboard Audierne2026\n4. \u2705 Generate an **API Key**:\n   \u2705 - Go to Settings \u2192 API Keys. one APIkey only not workspace related\n\n## Step 2: Install the Opik SDK\n\n\u2705 Add Opik to your project dependencies:\n\n```bash\npoetry add opik\n```\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-3-configure-opik-in-your-code",children:"Step 3: Configure Opik in Your Code"}),"\n",(0,i.jsx)(n.p,{children:"\u2705 set environment variables."}),"\n",(0,i.jsx)(n.h3,{id:"option-a---environment-variables-recommended-for-productionsecurity",children:"Option A \u2705 : Environment Variables (recommended for production/security)"}),"\n",(0,i.jsxs)(n.p,{children:["Create a ",(0,i.jsx)(n.code,{children:".env"})," file in your project root:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'OPIK_API_KEY=your_comet_api_key_here\nOPIK_WORKSPACE=ocapistaine-dev  # Optional, defaults to "default"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Load it in your app (e.g., using ",(0,i.jsx)(n.code,{children:"python-dotenv"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pip install python-dotenv\n"})}),"\n",(0,i.jsxs)(n.p,{children:["In your main app file (e.g., ",(0,i.jsx)(n.code,{children:"main.py"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from dotenv import load_dotenv\nload_dotenv()\n\nimport opik\n\n# Automatic configuration from env vars\nopik.configure()\n"})}),"\n",(0,i.jsx)(n.h2,{id:"step-4-instrument-your-code",children:"Step 4: Instrument Your Code"}),"\n",(0,i.jsx)(n.p,{children:"Use Opik decorators to trace functions automatically."}),"\n",(0,i.jsx)(n.h3,{id:"example-tracing-a-crawling-function",children:"Example: Tracing a Crawling Function"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import opik\nfrom opik import track\nimport requests\n\n@track\ndef crawl_page(url: str) -> str:\n    response = requests.get(url)\n    response.raise_for_status()\n\n    # Log custom metadata\n    opik.log_metadata({"url": url, "status_code": response.status_code})\n\n    return response.text  # Or processed content\n'})}),"\n",(0,i.jsx)(n.h3,{id:"example-tracing-llmagent-calls",children:"Example: Tracing LLM/Agent Calls"}),"\n",(0,i.jsx)(n.p,{children:"If using LangChain, CrewAI, or direct Mistral/OpenAI calls:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from opik import track\nfrom opik.integrations.langchain import OpikTracer  # If using LangChain\n\n# For LangChain\ntracer = OpikTracer()\nchain.invoke(input, config={"callbacks": [tracer]})\n\n# Or manual tracing for any LLM call\n@track\ndef generate_response(prompt: str, model: str = "mistral-large") -> str:\n    # Your LLM call here (e.g., via mistral client)\n    response = client.chat(prompt)\n\n    # Log inputs/outputs explicitly if needed\n    opik.log_input({"prompt": prompt})\n    opik.log_output({"response": response})\n\n    return response\n'})}),"\n",(0,i.jsx)(n.h3,{id:"example-tracing-fastapi-endpoints",children:"Example: Tracing FastAPI Endpoints"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from fastapi import FastAPI\nfrom opik import track\n\napp = FastAPI()\n\n@app.post("/process-contribution")\n@track  # Traces the entire endpoint\nasync def process_contribution(user_input: str):\n    # Your agent pipeline: crawl \u2192 generate \u2192 moderate\n    raw_data = crawl_page("https://example-commune.fr")\n    creative_output = generate_response(user_input + raw_data)\n    # ... moderation step\n\n    return {"response": creative_output}\n'})}),"\n",(0,i.jsx)(n.p,{children:"All traces will automatically appear in your Comet Opik dashboard."}),"\n",(0,i.jsx)(n.h2,{id:"step-5-run-and-test",children:"Step 5: Run and Test"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Start your app:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"uvicorn main:app --reload\n"})}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Trigger some endpoints or run crawling scripts."}),"\n",(0,i.jsxs)(n.li,{children:["Go to your Comet Opik dashboard (",(0,i.jsx)(n.a,{href:"https://www.comet.com",children:"comet.com \u2192 your workspace \u2192 Opik"}),") to view traces in real-time."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"You can now:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Browse trace timelines."}),"\n",(0,i.jsx)(n.li,{children:"Add evaluations (e.g., moderation scorer, fact-checker)."}),"\n",(0,i.jsx)(n.li,{children:"Create datasets from traced inputs/outputs."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"advanced-adding-evaluations",children:"Advanced: Adding Evaluations"}),"\n",(0,i.jsx)(n.p,{children:"Example: Moderation check on agent outputs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from opik.evaluation import evaluate\nfrom opik.evaluation.metrics import ModerationMetric\n\n@track\ndef moderated_generation(...):\n    output = generate_response(...)\n\n    # Run evaluation\n    moderation_metric = ModerationMetric()\n    evaluate(\n        task=lambda: output,\n        metrics=[moderation_metric]\n    )\n\n    return output\n"})}),"\n",(0,i.jsx)(n.h2,{id:"switching-to-self-hosted-opik-laterproduction",children:"Switching to Self-Hosted Opik (Later/Production)"}),"\n",(0,i.jsx)(n.p,{children:"Once cloud testing is solid and you need full data sovereignty:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Add a ",(0,i.jsx)(n.code,{children:"docker-compose.yml"})," to your repo (in ",(0,i.jsx)(n.code,{children:"/infra/"})," folder):","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'version: "3.8"\nservices:\n  opik-backend:\n    image: cometml/opik-backend:latest\n    environment:\n      - OPIK_POSTGRES_URL=postgresql://opik:password@postgres:5432/opik\n    ports:\n      - "8000:8000"\n\n  opik-frontend:\n    image: cometml/opik-frontend:latest\n    ports:\n      - "5173:5173"\n    depends_on:\n      - opik-backend\n\n  postgres:\n    image: postgres:15\n    environment:\n      - POSTGRES_USER=opik\n      - POSTGRES_PASSWORD=password\n      - POSTGRES_DB=opik\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n\n  redis:\n    image: redis:7\n\nvolumes:\n  postgres_data:\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Run ",(0,i.jsx)(n.code,{children:"docker compose up -d"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Update config:","\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'opik.configure(use_local=True, host="http://localhost:8000")\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Access dashboard at ",(0,i.jsx)(n.code,{children:"http://localhost:5173"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Check logs if traces aren't appearing."}),"\n",(0,i.jsx)(n.li,{children:"Ensure API key has correct permissions."}),"\n",(0,i.jsxs)(n.li,{children:["For issues: See ",(0,i.jsx)(n.a,{href:"https://github.com/comet-ml/opik/tree/main/docs",children:"Opik docs"})," or Comet support."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Start tracing \u2014 your crawling and agent workflows will thank you!"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}}}]);