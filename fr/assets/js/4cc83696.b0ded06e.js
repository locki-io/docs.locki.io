"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[6607],{8250(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"app/STREAMLIT_SETUP","title":"Streamlit Application Setup","description":"Guide for configuring and deploying the OCapistaine Streamlit application.","source":"@site/docs/app/STREAMLIT_SETUP.md","sourceDirName":"app","slug":"/app/STREAMLIT_SETUP","permalink":"/fr/docs/app/STREAMLIT_SETUP","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/app/STREAMLIT_SETUP.md","tags":[],"version":"current","frontMatter":{},"sidebar":"appSidebar","previous":{"title":"Streamlit Overview","permalink":"/fr/docs/app/streamlit-overview"},"next":{"title":"Streamlit Quick Start - Fix 403 WebSocket Error","permalink":"/fr/docs/app/STREAMLIT_QUICKSTART"}}');var t=r(4848),s=r(8453);const o={},l="Streamlit Application Setup",d={},c=[{value:"Deployment Architecture",id:"deployment-architecture",level:2},{value:"Production (Render)",id:"production-render",level:2},{value:"Configuration",id:"configuration",level:3},{value:"Vaettir Proxy (Nginx)",id:"vaettir-proxy-nginx",level:3},{value:"Deploy",id:"deploy",level:3},{value:"Development (ngrok)",id:"development-ngrok",level:2},{value:"Setup",id:"setup",level:3},{value:"Dynamic CORS (set_streamlit_env.py)",id:"dynamic-cors-set_streamlit_envpy",level:3},{value:"Local Only",id:"local-only",level:2},{value:"Static Config File",id:"static-config-file",level:2},{value:"Verification",id:"verification",level:2},{value:"Check WebSocket Connection",id:"check-websocket-connection",level:3},{value:"Test Endpoints",id:"test-endpoints",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"403 on WebSocket",id:"403-on-websocket",level:3},{value:"Render Cold Start",id:"render-cold-start",level:3},{value:"App Loads but Data Doesn&#39;t Update",id:"app-loads-but-data-doesnt-update",level:3},{value:"XSRF Token Errors",id:"xsrf-token-errors",level:3},{value:"Security",id:"security",level:2},{value:"Production",id:"production",level:3},{value:"Development",id:"development",level:3},{value:"References",id:"references",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"streamlit-application-setup",children:"Streamlit Application Setup"})}),"\n",(0,t.jsx)(n.p,{children:"Guide for configuring and deploying the OCapistaine Streamlit application."}),"\n",(0,t.jsx)(n.h2,{id:"deployment-architecture",children:"Deployment Architecture"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"Production:\n  User \u2192 ocapistaine.vaettir.locki.io \u2192 Vaettir Nginx \u2192 Render (ocapistaine.onrender.com)\n\nDevelopment:\n  User \u2192 ocapistaine-dev.vaettir.locki.io \u2192 Vaettir Nginx \u2192 ngrok \u2192 localhost:8502\n"})}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Environment"}),(0,t.jsx)(n.th,{children:"Public URL"}),(0,t.jsx)(n.th,{children:"Backend"}),(0,t.jsx)(n.th,{children:"CORS"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Production"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ocapistaine.vaettir.locki.io"})}),(0,t.jsx)(n.td,{children:"Render"}),(0,t.jsx)(n.td,{children:"Static (render.yaml)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Development"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ocapistaine-dev.vaettir.locki.io"})}),(0,t.jsx)(n.td,{children:"ngrok \u2192 local"}),(0,t.jsx)(n.td,{children:"Dynamic (set_streamlit_env.py)"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Local only"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"localhost:8502"})}),(0,t.jsx)(n.td,{children:"Direct"}),(0,t.jsx)(n.td,{children:"None needed"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"production-render",children:"Production (Render)"}),"\n",(0,t.jsx)(n.p,{children:"Production runs on Render with static configuration. No dynamic CORS scripts needed."}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsxs)(n.p,{children:["All Streamlit settings are in ",(0,t.jsx)(n.code,{children:"render.yaml"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'envVars:\n  - key: STREAMLIT_SERVER_ENABLE_CORS\n    value: "true"\n  - key: STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION\n    value: "false"\n  - key: STREAMLIT_SERVER_ALLOWED_ORIGINS\n    value: "https://ocapistaine.onrender.com,https://ocapistaine.vaettir.locki.io,https://vaettir.locki.io"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"vaettir-proxy-nginx",children:"Vaettir Proxy (Nginx)"}),"\n",(0,t.jsx)(n.p,{children:"The Vaettir proxy forwards HTTPS traffic to Render with SNI and WebSocket support:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-nginx",children:'location / {\n    set $backend "${OCAPISTAINE_TARGET_URL}";  # https://ocapistaine.onrender.com\n    proxy_pass $backend;\n\n    # SNI for Render shared hosting\n    proxy_ssl_server_name on;\n    proxy_ssl_name ocapistaine.onrender.com;\n\n    # Headers\n    proxy_set_header Host ocapistaine.onrender.com;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header X-Forwarded-Proto https;\n    proxy_set_header X-Forwarded-Host $host;\n\n    # WebSocket support (required for Streamlit)\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection $connection_upgrade;\n    proxy_buffering off;\n\n    # Timeouts for WebSocket and cold starts\n    proxy_read_timeout 3600;\n    proxy_connect_timeout 300;\n    proxy_send_timeout 3600;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Key points:"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"proxy_ssl_server_name on"})," is required for Render's shared hosting (SNI)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"proxy_connect_timeout 300"})," handles Render cold starts (standard plan)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"proxy_buffering off"})," is required for Streamlit WebSocket streaming"]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"Origin"})," header can be passed through since ",(0,t.jsx)(n.code,{children:"ALLOWED_ORIGINS"})," includes the vaettir domain"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"deploy",children:"Deploy"}),"\n",(0,t.jsx)(n.p,{children:"Push to main. Render auto-deploys from the repo:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"git push origin main\n# Render builds and deploys automatically (render.yaml)\n"})}),"\n",(0,t.jsx)(n.h2,{id:"development-ngrok",children:"Development (ngrok)"}),"\n",(0,t.jsxs)(n.p,{children:["Local development uses ngrok tunneled through the Vaettir proxy at ",(0,t.jsx)(n.code,{children:"ocapistaine-dev.vaettir.locki.io"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsxs)(n.strong,{children:["Configure ",(0,t.jsx)(n.code,{children:".env"}),":"]})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# ngrok tunnel domain\nNGROK_DOMAIN=your-dev-tunnel.ngrok-free.app\nSTREAMLIT_PORT=8502\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start Streamlit with CORS:"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Option A: Convenience script (recommended)\n./scripts/run_streamlit.sh\n\n# Option B: Manual\neval $(python scripts/set_streamlit_env.py)\nstreamlit run app/front.py\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start ngrok tunnel:"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"ngrok http 8502 --domain=$NGROK_DOMAIN\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"4",children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Access via:"})," ",(0,t.jsx)(n.code,{children:"https://ocapistaine-dev.vaettir.locki.io"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"dynamic-cors-set_streamlit_envpy",children:"Dynamic CORS (set_streamlit_env.py)"}),"\n",(0,t.jsxs)(n.p,{children:["For development, the script auto-generates ",(0,t.jsx)(n.code,{children:"STREAMLIT_SERVER_ALLOWED_ORIGINS"})," from:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"http://localhost:8502"})," (always)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"https://{NGROK_DOMAIN}"})," (if set in ",(0,t.jsx)(n.code,{children:".env"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"https://ocapistaine-dev.vaettir.locki.io"})," (dev proxy)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"https://ocapistaine.vaettir.locki.io"})," (production proxy)"]}),"\n",(0,t.jsxs)(n.li,{children:["Any ",(0,t.jsx)(n.code,{children:"STREAMLIT_CUSTOM_ORIGINS"})," entries"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"local-only",children:"Local Only"}),"\n",(0,t.jsx)(n.p,{children:"For quick local development without proxy:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"streamlit run app/front.py\n# Access at http://localhost:8502\n"})}),"\n",(0,t.jsx)(n.p,{children:"No CORS configuration needed for localhost-only access."}),"\n",(0,t.jsx)(n.h2,{id:"static-config-file",children:"Static Config File"}),"\n",(0,t.jsxs)(n.p,{children:["A base ",(0,t.jsx)(n.code,{children:".streamlit/config.toml"})," provides static defaults:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",children:'[server]\nenableCORS = true\nenableXsrfProtection = false\nport = 8502\naddress = "0.0.0.0"\nheadless = true\n\n[browser]\ngatherUsageStats = false\n\n[client]\nshowErrorDetails = true\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note:"})," Streamlit 1.53.0 does NOT support ",(0,t.jsx)(n.code,{children:"allowedOrigins"})," in config.toml. Use environment variables instead."]}),"\n",(0,t.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,t.jsx)(n.h3,{id:"check-websocket-connection",children:"Check WebSocket Connection"}),"\n",(0,t.jsx)(n.p,{children:"Open browser DevTools (F12) \u2192 Network tab:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Filter by ",(0,t.jsx)(n.code,{children:"WS"})," (WebSockets)"]}),"\n",(0,t.jsxs)(n.li,{children:["Look for ",(0,t.jsx)(n.code,{children:"/_stcore/stream"})]}),"\n",(0,t.jsxs)(n.li,{children:["Should show ",(0,t.jsx)(n.code,{children:"101 Switching Protocols"})," (success)"]}),"\n",(0,t.jsxs)(n.li,{children:["NOT ",(0,t.jsx)(n.code,{children:"403 Forbidden"})," (CORS issue)"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"test-endpoints",children:"Test Endpoints"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Health check\ncurl https://ocapistaine.vaettir.locki.io/_stcore/health\n\n# Host config\ncurl https://ocapistaine.vaettir.locki.io/_stcore/host-config\n"})}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"403-on-websocket",children:"403 on WebSocket"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Check CORS origins:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Production: check render.yaml STREAMLIT_SERVER_ALLOWED_ORIGINS\n\n# Development: verify dynamic config\npython scripts/set_streamlit_env.py\necho $STREAMLIT_SERVER_ALLOWED_ORIGINS\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Quick test with wildcard (dev only):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'export STREAMLIT_SERVER_ALLOWED_ORIGINS="*"\nstreamlit run app/front.py\n'})}),"\n",(0,t.jsx)(n.h3,{id:"render-cold-start",children:"Render Cold Start"}),"\n",(0,t.jsxs)(n.p,{children:["Standard plan instances may take 30-60s to wake up. The Vaettir proxy shows a custom error page during this time (",(0,t.jsx)(n.code,{children:"error-offline.html"}),"). The ",(0,t.jsx)(n.code,{children:"proxy_connect_timeout 300"})," ensures the proxy waits long enough."]}),"\n",(0,t.jsx)(n.h3,{id:"app-loads-but-data-doesnt-update",children:"App Loads but Data Doesn't Update"}),"\n",(0,t.jsx)(n.p,{children:"WebSocket not connected. Check:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Browser DevTools \u2192 Network \u2192 WS filter"}),"\n",(0,t.jsxs)(n.li,{children:["Proxy logs: ",(0,t.jsx)(n.code,{children:"docker compose logs"})," on the Vaettir server"]}),"\n",(0,t.jsx)(n.li,{children:"Render logs: Render dashboard \u2192 Logs"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"xsrf-token-errors",children:"XSRF Token Errors"}),"\n",(0,t.jsxs)(n.p,{children:["Disabled by default (",(0,t.jsx)(n.code,{children:"enableXsrfProtection = false"}),") since the app runs behind a trusted HTTPS proxy."]}),"\n",(0,t.jsx)(n.h2,{id:"security",children:"Security"}),"\n",(0,t.jsx)(n.h3,{id:"production",children:"Production"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Specific origins only in ",(0,t.jsx)(n.code,{children:"render.yaml"})," (no wildcards)"]}),"\n",(0,t.jsx)(n.li,{children:"HTTPS enforced by both Render and Vaettir proxy"}),"\n",(0,t.jsxs)(n.li,{children:["Authentication via ",(0,t.jsx)(n.code,{children:"STREAMLIT_AUTH_PASSWORD"})," (set in Render dashboard)"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"development",children:"Development"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Dynamic origins via ",(0,t.jsx)(n.code,{children:"set_streamlit_env.py"})]}),"\n",(0,t.jsxs)(n.li,{children:["Can use wildcard for testing: ",(0,t.jsx)(n.code,{children:"STREAMLIT_SERVER_ALLOWED_ORIGINS=*"})]}),"\n",(0,t.jsx)(n.li,{children:"ngrok provides HTTPS tunnel"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.streamlit.io/develop/api-reference/configuration/config.toml",children:"Streamlit Configuration"})}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/fr/docs/app/CORS_STRATEGY",children:"CORS Strategy"})," - Dynamic CORS details"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/fr/docs/orchestration/PROXY_MANAGEMENT",children:"Proxy Configuration"})," - Vaettir proxy setup"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}},8453(e,n,r){r.d(n,{R:()=>o,x:()=>l});var i=r(6540);const t={},s=i.createContext(t);function o(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);