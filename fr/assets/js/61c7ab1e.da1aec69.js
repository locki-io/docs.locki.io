"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[3581],{2588(e,s,n){n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"app/scheduler/USAGE_EXAMPLES","title":"OCapistaine Scheduler Usage Examples","description":"Complete guide for common scheduler tasks with code examples.","source":"@site/docs/app/scheduler/USAGE_EXAMPLES.md","sourceDirName":"app/scheduler","slug":"/app/scheduler/USAGE_EXAMPLES","permalink":"/fr/docs/app/scheduler/USAGE_EXAMPLES","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/app/scheduler/USAGE_EXAMPLES.md","tags":[],"version":"current","frontMatter":{}}');var r=n(4848),a=n(8453);const i={},l="OCapistaine Scheduler Usage Examples",c={},d=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"Adding a New Task",id:"adding-a-new-task",level:2},{value:"Step 1: Create Task File",id:"step-1-create-task-file",level:3},{value:"Step 2: Export from Task Registry",id:"step-2-export-from-task-registry",level:3},{value:"Step 3: Schedule in Scheduler",id:"step-3-schedule-in-scheduler",level:3},{value:"Step 4: Test",id:"step-4-test",level:3},{value:"Database and Redis Access",id:"database-and-redis-access",level:2},{value:"Redis Usage - Scheduler Locks (db=6)",id:"redis-usage---scheduler-locks-db6",level:3},{value:"Redis Usage - Application Data (db=5)",id:"redis-usage---application-data-db5",level:3},{value:"Testing Tasks",id:"testing-tasks",level:2},{value:"Unit Test Pattern",id:"unit-test-pattern",level:3},{value:"Integration Test Pattern",id:"integration-test-pattern",level:3},{value:"Manual Testing Commands",id:"manual-testing-commands",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Task Not Running",id:"task-not-running",level:3},{value:"Task Runs Multiple Times",id:"task-runs-multiple-times",level:3},{value:"Circular Import Error",id:"circular-import-error",level:3},{value:"Cron Schedule Reference",id:"cron-schedule-reference",level:2},{value:"OCapistaine-Specific Tasks",id:"ocapistaine-specific-tasks",level:2},{value:"task_contributions_analysis",id:"task_contributions_analysis",level:3},{value:"task_opik_experiment",id:"task_opik_experiment",level:3},{value:"task_firecrawl",id:"task_firecrawl",level:3},{value:"References",id:"references",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"ocapistaine-scheduler-usage-examples",children:"OCapistaine Scheduler Usage Examples"})}),"\n",(0,r.jsx)(s.p,{children:"Complete guide for common scheduler tasks with code examples."}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Last Updated:"})," February 2026"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#adding-a-new-task",children:"Adding a New Task"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#database-and-redis-access",children:"Database and Redis Access"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#testing-tasks",children:"Testing Tasks"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#troubleshooting",children:"Troubleshooting"})}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"adding-a-new-task",children:"Adding a New Task"}),"\n",(0,r.jsx)(s.h3,{id:"step-1-create-task-file",children:"Step 1: Create Task File"}),"\n",(0,r.jsxs)(s.p,{children:["Create ",(0,r.jsx)(s.code,{children:"app/services/tasks/task_mynewtask.py"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'"""\nMy New Task\n\nDescription of what this task does.\n"""\n\nfrom app.services.tasks import TaskError, _task_boilerplate, REDIS_SUCCESS_TTL\n\n\ndef task_mynewtask(date_string: str = None) -> dict:\n    """\n    Brief description of what this task does.\n\n    Args:\n        date_string: Date in YYYYMMDD format (optional, defaults to today)\n\n    Returns:\n        dict: Task result with status, errors, and custom fields\n\n    Raises:\n        TaskError: For retry-able failures\n    """\n    # Use boilerplate for lock/success key management\n    l, lock_key, success_key, result, task_id = _task_boilerplate(\n        "task_mynewtask", date_string\n    )\n\n    # Early return if already completed or running\n    if result["status"] == "skipped":\n        return result\n\n    # Add custom result fields\n    result["items_processed"] = 0\n\n    try:\n        # Your task logic here\n        print(f"Running task_mynewtask for {date_string}")\n\n        # Example: Process items\n        items = []  # Fetch your items here\n        for item in items:\n            # Process item\n            result["items_processed"] += 1\n\n        # Mark as completed\n        result["status"] = "success"\n        l.set(success_key, "completed", ex=REDIS_SUCCESS_TTL)\n\n        print(f"task_mynewtask completed: {result[\'items_processed\']} items processed")\n        return result\n\n    except Exception as e:\n        print(f"task_mynewtask failed: {e}")\n        result["status"] = "failed"\n        result["errors"].append(str(e))\n        raise TaskError("failed", str(e))\n\n    finally:\n        l.delete(lock_key)  # Always release lock\n'})}),"\n",(0,r.jsx)(s.h3,{id:"step-2-export-from-task-registry",children:"Step 2: Export from Task Registry"}),"\n",(0,r.jsxs)(s.p,{children:["Add to ",(0,r.jsx)(s.code,{children:"app/services/tasks/__init__.py"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'# Import at bottom of file (after _task_boilerplate definition)\nfrom app.services.tasks.task_mynewtask import task_mynewtask\n\n# Add to __all__\n__all__ = [\n    # ... existing exports ...\n    "task_mynewtask",\n]\n'})}),"\n",(0,r.jsx)(s.h3,{id:"step-3-schedule-in-scheduler",children:"Step 3: Schedule in Scheduler"}),"\n",(0,r.jsxs)(s.p,{children:["Add to ",(0,r.jsx)(s.code,{children:"app/services/scheduler/__init__.py"}),":"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Option A: Add to daily task chain"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'def orchestrate_task_chain():\n    task_chain = [\n        # ... existing tasks ...\n        {\n            "id": "task_mynewtask",\n            "func": task_mynewtask,\n            "depends_on": ["task_contributions_analysis"],  # Dependencies\n        },\n    ]\n'})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Option B: Schedule as cron job"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'# In _register_jobs()\nTASK_MYNEWTASK_CRON = "0 12 * * *"  # Daily at noon\n\nscheduler.add_job(\n    func=task_mynewtask,\n    trigger=CronTrigger.from_crontab(TASK_MYNEWTASK_CRON),\n    id="task_mynewtask",\n    replace_existing=True,\n    misfire_grace_time=300,\n)\n'})}),"\n",(0,r.jsx)(s.h3,{id:"step-4-test",children:"Step 4: Test"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# Import test\npython3 -c "from app.services.tasks import task_mynewtask; print(\'Import OK\')"\n\n# Execution test\npython3 -c "\nfrom app.services.tasks import task_mynewtask\nresult = task_mynewtask(\'20260203\')\nprint(f\'Status: {result[\\"status\\"]}\')\n"\n\n# Check Redis keys\nredis-cli -n 6 KEYS "success:task_mynewtask:*"\nredis-cli -n 6 KEYS "lock:task_mynewtask:*"\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"database-and-redis-access",children:"Database and Redis Access"}),"\n",(0,r.jsx)(s.h3,{id:"redis-usage---scheduler-locks-db6",children:"Redis Usage - Scheduler Locks (db=6)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from app.services.scheduler.utils import get_scheduler_redis\n\nl = get_scheduler_redis()\n\n# Acquire lock (nx=True means "only if not exists")\ntask_id = "unique-task-id"\nacquired = l.set("lock:task_name:20260203", task_id, ex=300, nx=True)\n\nif not acquired:\n    print("Task already running")\nelse:\n    try:\n        # Do work...\n        pass\n    finally:\n        # Always release lock\n        l.delete("lock:task_name:20260203")\n\n# Set success key\nl.set("success:task_name:20260203", "completed", ex=86400)\n\n# Check if completed\nif l.exists("success:task_name:20260203"):\n    print("Task already completed today")\n'})}),"\n",(0,r.jsx)(s.h3,{id:"redis-usage---application-data-db5",children:"Redis Usage - Application Data (db=5)"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from app.data.redis_client import redis_connection\nimport json\n\n# Store contribution data\nwith redis_connection() as r:\n    key = f"contribution:{contribution_id}"\n    r.setex(key, 86400, json.dumps(contribution_data))\n\n# Retrieve contribution data\nwith redis_connection() as r:\n    data = r.get(key)\n    if data:\n        contribution = json.loads(data)\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"testing-tasks",children:"Testing Tasks"}),"\n",(0,r.jsx)(s.h3,{id:"unit-test-pattern",children:"Unit Test Pattern"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'def test_task_mynewtask():\n    """Test task logic."""\n    from app.services.scheduler.utils import get_scheduler_redis\n\n    # Clear any existing keys\n    l = get_scheduler_redis()\n    l.delete("success:task_mynewtask:20260203")\n    l.delete("lock:task_mynewtask:20260203")\n\n    # Execute task\n    from app.services.tasks import task_mynewtask\n    result = task_mynewtask("20260203")\n\n    # Verify result\n    assert result["status"] == "success"\n    assert len(result["errors"]) == 0\n\n    # Verify Redis keys\n    assert l.exists("success:task_mynewtask:20260203")\n    assert not l.exists("lock:task_mynewtask:20260203")  # Released\n'})}),"\n",(0,r.jsx)(s.h3,{id:"integration-test-pattern",children:"Integration Test Pattern"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'import asyncio\n\nasync def test_scheduler_startup():\n    """Test scheduler starts correctly."""\n    from app.services.scheduler import start_scheduler, stop_scheduler, get_scheduler_status\n\n    # Start scheduler\n    await start_scheduler()\n\n    # Check status\n    status = get_scheduler_status()\n    assert status["status"] == "running"\n    assert status["job_count"] > 0\n\n    # Stop scheduler\n    await stop_scheduler()\n'})}),"\n",(0,r.jsx)(s.h3,{id:"manual-testing-commands",children:"Manual Testing Commands"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# Run task directly\ncd /Users/jnxmas/dev/ocapistaine\npoetry run python -c "\nfrom app.services.tasks import task_contributions_analysis\nresult = task_contributions_analysis(\'20260203\')\nprint(result)\n"\n\n# Check scheduler status\npoetry run python -c "\nfrom app.services.scheduler import get_scheduler_status\nprint(get_scheduler_status())\n"\n\n# View task status in Redis\nredis-cli -n 6 KEYS "success:*20260203"\nredis-cli -n 6 KEYS "lock:*20260203"\n\n# Clear stuck lock\nredis-cli -n 6 DEL "lock:task_contributions_analysis:20260203"\n\n# Re-run task (clear success key first)\nredis-cli -n 6 DEL "success:task_contributions_analysis:20260203"\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsx)(s.h3,{id:"task-not-running",children:"Task Not Running"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Check 1:"})," Is scheduler running?"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"from app.services.scheduler import get_scheduler_status\nstatus = get_scheduler_status()\nprint(f\"Running: {status['status']}\")\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Check 2:"})," Is task scheduled?"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"from app.services.scheduler import get_scheduler_status\nstatus = get_scheduler_status()\nfor job in status[\"jobs\"]:\n    print(f\"{job['id']}: next run at {job['next_run']}\")\n"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Check 3:"})," Is lock held?"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'redis-cli -n 6 KEYS "lock:task_name:*"\nredis-cli -n 6 GET "lock:task_name:20260203"\n'})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Check 4:"})," Already completed?"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'redis-cli -n 6 KEYS "success:task_name:*"\nredis-cli -n 6 GET "success:task_name:20260203"\n'})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Fix:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'# Clear stuck lock (if confirmed stale)\nredis-cli -n 6 DEL "lock:task_contributions_analysis:20260203"\n\n# Re-run task (clear success key)\nredis-cli -n 6 DEL "success:task_contributions_analysis:20260203"\n\n# Manually trigger\npoetry run python -c "\nfrom app.services.tasks import task_contributions_analysis\ntask_contributions_analysis(\'20260203\')\n"\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"task-runs-multiple-times",children:"Task Runs Multiple Times"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Cause:"})," Lock not acquired properly or released prematurely."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Fix:"})," Always use ",(0,r.jsx)(s.code,{children:"_task_boilerplate"})," and release lock in ",(0,r.jsx)(s.code,{children:"finally"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'l, lock_key, success_key, result, task_id = _task_boilerplate(...)\n\nif result["status"] == "skipped":\n    return result\n\ntry:\n    # Task logic\n    pass\nfinally:\n    l.delete(lock_key)  # CRITICAL: Always release\n'})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"circular-import-error",children:"Circular Import Error"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Symptom:"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"ImportError: cannot import name 'X' from partially initialized module\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Rules:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Tasks import from ",(0,r.jsx)(s.code,{children:"app.services.scheduler.utils"})," (NOT ",(0,r.jsx)(s.code,{children:"app.services.scheduler"}),")"]}),"\n",(0,r.jsxs)(s.li,{children:["Tasks import from ",(0,r.jsx)(s.code,{children:"app.services.tasks"})," (for boilerplate)"]}),"\n",(0,r.jsxs)(s.li,{children:["Scheduler imports from ",(0,r.jsx)(s.code,{children:"app.services.tasks"})]}),"\n",(0,r.jsxs)(s.li,{children:["Tasks NEVER import from ",(0,r.jsx)(s.code,{children:"app.services.scheduler"})]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"cron-schedule-reference",children:"Cron Schedule Reference"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'# Every day at 3 AM (nightly crawl)\n"0 3 * * *"\n\n# Every day at 5 AM (daily experiments)\n"0 5 * * *"\n\n# Every 7 minutes from 6 AM to 11 PM (task chain)\n"*/7 6-23 * * *"\n\n# Every 15 minutes from 9 AM to 6 PM\n"*/15 9-18 * * *"\n\n# Weekdays only at noon\n"0 12 * * 1-5"\n\n# First day of month\n"0 0 1 * *"\n'})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Tool:"})," Use ",(0,r.jsx)(s.code,{children:'CronTrigger.from_crontab("...")'})," for validation."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"ocapistaine-specific-tasks",children:"OCapistaine-Specific Tasks"}),"\n",(0,r.jsx)(s.h3,{id:"task_contributions_analysis",children:"task_contributions_analysis"}),"\n",(0,r.jsx)(s.p,{children:"Validates citizen contributions using Forseti agent:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"# Check validation results\nfrom app.services.tasks import task_contributions_analysis\nresult = task_contributions_analysis()\nprint(f\"Validated: {result['contributions_validated']}\")\nprint(f\"Approved: {result['contributions_approved']}\")\nprint(f\"Flagged: {result['contributions_flagged']}\")\n"})}),"\n",(0,r.jsx)(s.h3,{id:"task_opik_experiment",children:"task_opik_experiment"}),"\n",(0,r.jsx)(s.p,{children:"Runs LLM evaluation experiments:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"# Run experiments manually\nfrom app.services.tasks import task_opik_experiment\nresult = task_opik_experiment()\nprint(f\"Experiments run: {result['experiments_run']}\")\nprint(f\"Metrics: {result.get('metrics', {})}\")\n"})}),"\n",(0,r.jsx)(s.h3,{id:"task_firecrawl",children:"task_firecrawl"}),"\n",(0,r.jsx)(s.p,{children:"Crawls municipal documents:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"# Trigger crawl manually\nfrom app.services.tasks import task_firecrawl\nresult = task_firecrawl()\nprint(f\"Documents crawled: {result['documents_crawled']}\")\nprint(f\"Sources: {result.get('sources', {})}\")\n"})}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"references",children:"References"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"/fr/docs/app/scheduler/",children:"Main Scheduler README"})," - Architecture overview"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"/fr/docs/app/scheduler/TASK_BOILERPLATE",children:"Task Boilerplate Guide"})," - Detailed boilerplate usage"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Last Updated:"})," February 2026"]})]})}function u(e={}){const{wrapper:s}={...(0,a.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},8453(e,s,n){n.d(s,{R:()=>i,x:()=>l});var t=n(6540);const r={},a=t.createContext(r);function i(e){const s=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(a.Provider,{value:s},e.children)}}}]);