"use strict";(globalThis.webpackChunkdocs_locki_io=globalThis.webpackChunkdocs_locki_io||[]).push([[3362],{5253(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"orchestration/WEBSOCKET_FIX","title":"WebSocket Fix for Streamlit Proxied Through ngrok","description":"Problem Summary","source":"@site/docs/orchestration/WEBSOCKET_FIX.md","sourceDirName":"orchestration","slug":"/orchestration/WEBSOCKET_FIX","permalink":"/fr/docs/orchestration/WEBSOCKET_FIX","draft":false,"unlisted":false,"editUrl":"https://github.com/locki-io/docs.locki.io/tree/main/docs/orchestration/WEBSOCKET_FIX.md","tags":[],"version":"current","frontMatter":{}}');var i=r(4848),s=r(8453);const t={},c="WebSocket Fix for Streamlit Proxied Through ngrok",l={},a=[{value:"Problem Summary",id:"problem-summary",level:2},{value:"Root Causes (Multiple Issues)",id:"root-causes-multiple-issues",level:2},{value:"1. Missing WebSocket Headers",id:"1-missing-websocket-headers",level:3},{value:"2. Cross-Origin WebSocket Rejection (Main Issue)",id:"2-cross-origin-websocket-rejection-main-issue",level:3},{value:"3. ngrok Interstitial Page",id:"3-ngrok-interstitial-page",level:3},{value:"Solution: Complete Proxy Configuration",id:"solution-complete-proxy-configuration",level:2},{value:"Deployment Steps",id:"deployment-steps",level:2},{value:"Step 1: Create/Update Proxy Config",id:"step-1-createupdate-proxy-config",level:3},{value:"Step 2: Rebuild and Restart",id:"step-2-rebuild-and-restart",level:3},{value:"Step 3: Verify",id:"step-3-verify",level:3},{value:"Testing WebSocket",id:"testing-websocket",level:2},{value:"From Command Line (HTTP/1.1)",id:"from-command-line-http11",level:3},{value:"In Browser",id:"in-browser",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"403 &quot;Cross origin websockets not allowed&quot;",id:"403-cross-origin-websockets-not-allowed",level:3},{value:"400 &quot;Can Upgrade only to WebSocket&quot;",id:"400-can-upgrade-only-to-websocket",level:3},{value:"502 Bad Gateway",id:"502-bad-gateway",level:3},{value:"WebSocket works in curl but not browser",id:"websocket-works-in-curl-but-not-browser",level:3},{value:"Custom Error Page for Offline Agents",id:"custom-error-page-for-offline-agents",level:2},{value:"How it Works",id:"how-it-works",level:3},{value:"Setup",id:"setup",level:3},{value:"Testing the Error Page",id:"testing-the-error-page",level:3},{value:"Proxy Config File Management",id:"proxy-config-file-management",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"websocket-fix-for-streamlit-proxied-through-ngrok",children:"WebSocket Fix for Streamlit Proxied Through ngrok"})}),"\n",(0,i.jsx)(n.h2,{id:"problem-summary",children:"Problem Summary"}),"\n",(0,i.jsxs)(n.p,{children:["WebSocket connections to ",(0,i.jsx)(n.code,{children:"wss://ocapistaine.vaettir.locki.io/_stcore/stream"})," failing with:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'"WebSocket connection failed"'}),"\n",(0,i.jsx)(n.li,{children:"Browser console shows repeated connection attempts"}),"\n",(0,i.jsx)(n.li,{children:'HTTP 403 responses with "Cross origin websockets not allowed"'}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"root-causes-multiple-issues",children:"Root Causes (Multiple Issues)"}),"\n",(0,i.jsx)(n.h3,{id:"1-missing-websocket-headers",children:"1. Missing WebSocket Headers"}),"\n",(0,i.jsx)(n.p,{children:"The nginx proxy needs proper WebSocket upgrade headers for Streamlit's real-time communication."}),"\n",(0,i.jsx)(n.h3,{id:"2-cross-origin-websocket-rejection-main-issue",children:"2. Cross-Origin WebSocket Rejection (Main Issue)"}),"\n",(0,i.jsxs)(n.p,{children:["When browser connects to ",(0,i.jsx)(n.code,{children:"https://ocapistaine.vaettir.locki.io"}),", the ",(0,i.jsx)(n.code,{children:"Origin"})," header is set to that domain. But ngrok expects the Origin to match ",(0,i.jsx)(n.code,{children:"https://ocapistaine.ngrok-free.app"}),", causing:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"HTTP/1.1 403 Forbidden\nCross origin websockets not allowed\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-ngrok-interstitial-page",children:"3. ngrok Interstitial Page"}),"\n",(0,i.jsx)(n.p,{children:"ngrok's free tier shows an interstitial page that can block API/WebSocket requests."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"solution-complete-proxy-configuration",children:"Solution: Complete Proxy Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Use the template at ",(0,i.jsx)(n.code,{children:"proxy-configs/agent.conf.template.example"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:'events {\n    worker_connections 1024;\n}\n\nhttp {\n    # Use Google DNS, disable IPv6\n    resolver 8.8.8.8 8.8.4.4 valid=300s ipv6=off;\n    resolver_timeout 5s;\n\n    # Map for WebSocket upgrade (required for Streamlit, etc.)\n    map $http_upgrade $connection_upgrade {\n        default upgrade;\n        \'\' close;\n    }\n\n    server {\n        listen 80;\n\n        location / {\n            # Use variable to force DNS resolution and avoid IPv6\n            set $backend "${AGENT_NAME_TARGET_URL}";\n            proxy_pass $backend;\n\n            # Enable SNI for ngrok\n            proxy_ssl_server_name on;\n            proxy_ssl_name AGENT_NAME.ngrok-free.app;\n\n            # Set Host header to ngrok domain (required by ngrok)\n            proxy_set_header Host AGENT_NAME.ngrok-free.app;\n            proxy_set_header X-Real-IP $remote_addr;\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n            proxy_set_header X-Forwarded-Proto https;\n            proxy_set_header X-Forwarded-Host $host;\n\n            # CRITICAL: Override Origin header for cross-origin WebSocket\n            # Without this, ngrok rejects with "Cross origin websockets not allowed"\n            proxy_set_header Origin https://AGENT_NAME.ngrok-free.app;\n\n            # Bypass ngrok interstitial page (required for free tier, harmless for paid)\n            proxy_set_header ngrok-skip-browser-warning "true";\n\n            # WebSocket support (for Streamlit)\n            proxy_http_version 1.1;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection $connection_upgrade;\n\n            # Disable buffering for WebSocket\n            proxy_buffering off;\n\n            # Timeout settings for long-running requests and WebSockets\n            proxy_read_timeout 3600;\n            proxy_connect_timeout 300;\n            proxy_send_timeout 3600;\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Key headers for WebSocket through ngrok:"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Header"}),(0,i.jsx)(n.th,{children:"Purpose"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Origin: https://AGENT.ngrok-free.app"})}),(0,i.jsx)(n.td,{children:'Prevents "Cross origin websockets not allowed"'})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"ngrok-skip-browser-warning: true"})}),(0,i.jsx)(n.td,{children:"Bypasses ngrok interstitial"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Upgrade: $http_upgrade"})}),(0,i.jsx)(n.td,{children:"WebSocket protocol upgrade"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Connection: $connection_upgrade"})}),(0,i.jsx)(n.td,{children:"WebSocket connection handling"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"Host: AGENT.ngrok-free.app"})}),(0,i.jsx)(n.td,{children:"Required for ngrok routing"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"deployment-steps",children:"Deployment Steps"}),"\n",(0,i.jsx)(n.h3,{id:"step-1-createupdate-proxy-config",children:"Step 1: Create/Update Proxy Config"}),"\n",(0,i.jsx)(n.p,{children:"On the server:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ssh <user>@<server>\ncd ~/vaettir\n\n# Copy from example and customize\ncp proxy-configs/agent.conf.template.example proxy-configs/ocapistaine.conf.template\n\n# Edit and replace AGENT_NAME with ocapistaine\nnano proxy-configs/ocapistaine.conf.template\n"})}),"\n",(0,i.jsx)(n.p,{children:"Replace all instances of:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"AGENT_NAME"})," -> ",(0,i.jsx)(n.code,{children:"ocapistaine"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"AGENT_NAME_TARGET_URL"})," -> ",(0,i.jsx)(n.code,{children:"OCAPISTAINE_TARGET_URL"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"step-2-rebuild-and-restart",children:"Step 2: Rebuild and Restart"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose build ocapistaine\ndocker compose --profile production --profile proxy up -d ocapistaine\n"})}),"\n",(0,i.jsx)(n.h3,{id:"step-3-verify",children:"Step 3: Verify"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Check container is running\ndocker compose ps ocapistaine\n\n# Check config has Origin header\ndocker exec vaettir-ocapistaine-1 cat /etc/nginx/nginx.conf | grep "Origin"\n\n# Should show: proxy_set_header Origin https://ocapistaine.ngrok-free.app;\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"testing-websocket",children:"Testing WebSocket"}),"\n",(0,i.jsx)(n.h3,{id:"from-command-line-http11",children:"From Command Line (HTTP/1.1)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# This should return 101 Switching Protocols\ncurl --http1.1 -si "https://ocapistaine.vaettir.locki.io/_stcore/stream" \\\n  -H "Upgrade: websocket" \\\n  -H "Connection: Upgrade" \\\n  -H "Sec-WebSocket-Key: test123" \\\n  -H "Sec-WebSocket-Version: 13" | head -10\n'})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Expected output:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"HTTP/1.1 101 Switching Protocols\nConnection: upgrade\nUpgrade: websocket\n"})}),"\n",(0,i.jsx)(n.h3,{id:"in-browser",children:"In Browser"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Open ",(0,i.jsx)(n.code,{children:"https://ocapistaine.vaettir.locki.io"})]}),"\n",(0,i.jsx)(n.li,{children:'Open DevTools (F12) -> Network tab -> Filter "WS"'}),"\n",(0,i.jsxs)(n.li,{children:["Look for ",(0,i.jsx)(n.code,{children:"_stcore/stream"})," with status ",(0,i.jsx)(n.strong,{children:"101 Switching Protocols"})]}),"\n",(0,i.jsx)(n.li,{children:'Console should NOT show "WebSocket connection failed" errors'}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"403-cross-origin-websockets-not-allowed",children:'403 "Cross origin websockets not allowed"'}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause:"})," Origin header mismatch"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Fix:"})," Ensure this line is in nginx config:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"proxy_set_header Origin https://ocapistaine.ngrok-free.app;\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then rebuild:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose build ocapistaine\ndocker compose --profile production --profile proxy up -d ocapistaine\n"})}),"\n",(0,i.jsx)(n.h3,{id:"400-can-upgrade-only-to-websocket",children:'400 "Can Upgrade only to WebSocket"'}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause:"})," HTTP/2 request (browsers default to HTTP/2)"]}),"\n",(0,i.jsx)(n.p,{children:"This is expected for regular HTTP requests. WebSocket connections should work in browser."}),"\n",(0,i.jsx)(n.h3,{id:"502-bad-gateway",children:"502 Bad Gateway"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause:"})," ngrok tunnel not running or unreachable"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Fix:"})," Check ngrok is running locally:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"curl -I https://ocapistaine.ngrok-free.app\n# Should return 200 OK\n"})}),"\n",(0,i.jsx)(n.h3,{id:"websocket-works-in-curl-but-not-browser",children:"WebSocket works in curl but not browser"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause:"})," Traefik HTTP/2 WebSocket handling"]}),"\n",(0,i.jsx)(n.p,{children:"Traefik v3.2.5+ has fixes for HTTP/2 WebSocket. Ensure Traefik is up to date:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker exec vaettir-traefik-1 traefik version\n# Should be 3.2.5 or later\n"})}),"\n",(0,i.jsx)(n.p,{children:"Restart Traefik if needed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose restart traefik\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"custom-error-page-for-offline-agents",children:"Custom Error Page for Offline Agents"}),"\n",(0,i.jsxs)(n.p,{children:["When ngrok is down (ERR_NGROK_3200), nginx shows a ",(0,i.jsx)(n.strong,{children:"custom branded page"})," with a Discord invite link instead of the default ngrok error."]}),"\n",(0,i.jsx)(n.h3,{id:"how-it-works",children:"How it Works"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Error Detection"}),": nginx intercepts upstream errors (502, 503, 504)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Custom Page"}),": Shows ",(0,i.jsx)(n.code,{children:"/error-offline.html"})," with Discord link"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Environment Variable"}),": ",(0,i.jsx)(n.code,{children:"DISCORD_INVITE_URL"})," is injected at container startup"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"setup",children:"Setup"}),"\n",(0,i.jsxs)(n.p,{children:["Add to your ",(0,i.jsx)(n.code,{children:".env"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"DISCORD_INVITE_URL=https://discord.gg/your-invite-code\n"})}),"\n",(0,i.jsx)(n.p,{children:"Then rebuild:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"docker compose build ocapistaine\ndocker compose --profile production --profile proxy up -d ocapistaine\n"})}),"\n",(0,i.jsx)(n.h3,{id:"testing-the-error-page",children:"Testing the Error Page"}),"\n",(0,i.jsx)(n.p,{children:"Stop your ngrok tunnel to simulate the agent being offline:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Locally: kill ngrok\npkill ngrok\n\n# Then visit your proxy URL\ncurl https://ocapistaine.vaettir.locki.io\n# Should show custom page with Discord link\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"proxy-config-file-management",children:"Proxy Config File Management"}),"\n",(0,i.jsxs)(n.p,{children:["Proxy configs are ",(0,i.jsx)(n.strong,{children:"not tracked in git"})," (environment-specific):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"proxy-configs/\n\u251c\u2500\u2500 agent.conf.template.example  # Git-tracked template\n\u251c\u2500\u2500 error-offline.html.template  # Git-tracked error page\n\u251c\u2500\u2500 ocapistaine.conf.template    # Server-specific (gitignored)\n\u2514\u2500\u2500 other-agent.conf.template    # Server-specific (gitignored)\n"})}),"\n",(0,i.jsx)(n.p,{children:"To create a new agent proxy:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Copy ",(0,i.jsx)(n.code,{children:"agent.conf.template.example"})," to ",(0,i.jsx)(n.code,{children:"AGENT_NAME.conf.template"})]}),"\n",(0,i.jsxs)(n.li,{children:["Replace ",(0,i.jsx)(n.code,{children:"AGENT_NAME"})," with your agent name"]}),"\n",(0,i.jsxs)(n.li,{children:["Set environment variables in ",(0,i.jsx)(n.code,{children:".env"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"AGENT_NAME_TARGET_URL"})," - ngrok or service URL"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"DISCORD_INVITE_URL"})," - Discord invite for error page"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/fr/docs/orchestration/PROXY_MANAGEMENT",children:"PROXY_MANAGEMENT.md"})," - Comprehensive proxy management guide"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://docs.streamlit.io/develop/concepts/architecture/architecture#client-server-communication",children:"Streamlit WebSocket Docs"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"http://nginx.org/en/docs/http/websocket.html",children:"Nginx WebSocket Proxying"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/traefik/traefik/issues/11405",children:"Traefik WebSocket Issues"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>t,x:()=>c});var o=r(6540);const i={},s=o.createContext(i);function t(e){const n=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);